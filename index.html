<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-section {
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }
        
        .upload-section h1 {
            font-size: 2.5rem;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .upload-section p {
            color: #718096;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .upload-tip {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: left;
            display: inline-block;
        }
        
        .upload-tip strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        
        .upload-tip p {
            color: #4a5568;
            font-size: 0.95rem;
            margin: 0;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #8b5cf6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7c3aed;
        }
        
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .date-filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f7fafc;
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }
        
        .date-filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
        }
        
        .date-filter-select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #2d3748;
        }
        
        .date-filter-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .custom-date-inputs {
            display: none;
            gap: 10px;
            align-items: center;
        }
        
        .custom-date-inputs.active {
            display: flex;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .apply-filter-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .apply-filter-btn:hover {
            opacity: 0.9;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2rem;
        }
        
        .header p {
            color: #718096;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f7fafc;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #4a5568;
        }
        
        .tab:hover {
            background: #edf2f7;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-sub {
            color: #a0aec0;
            font-size: 0.85rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .chart-container h3 {
            color: #2d3748;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .action-plan {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .plan-section {
            margin-bottom: 30px;
        }
        
        .plan-section h4 {
            color: #2d3748;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .plan-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: start;
            gap: 10px;
        }
        
        .plan-checkbox {
            margin-top: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .plan-text {
            flex: 1;
            color: #4a5568;
            line-height: 1.6;
        }
        
        .plan-impact {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .budget-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .budget-item {
            margin-bottom: 20px;
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .budget-input {
            width: 120px;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .budget-bar {
            height: 30px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .budget-fill {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: width 0.5s ease;
        }
        
        .budget-fill.good {
            background: #10b981;
            color: white;
        }
        
        .budget-fill.warning {
            background: #f59e0b;
            color: white;
        }
        
        .budget-fill.danger {
            background: #ef4444;
            color: white;
        }
        
        .transactions-table {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .table-scroll-container {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.85rem;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
            color: #2d3748;
        }
        
        tfoot td {
            border-top: 3px solid #667eea;
            position: sticky;
            bottom: 0;
            background: #f7fafc;
            z-index: 10;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .positive {
            color: #48bb78;
            font-weight: 600;
        }
        
        .negative {
            color: #f56565;
            font-weight: 600;
        }
        
        .category-tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-tag:hover {
            transform: scale(1.05);
        }
        
        .transaction-row.selected {
            background: #e0e7ff !important;
        }
        
        .select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .bulk-actions {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .bulk-actions.active {
            display: flex;
        }
        
        .bulk-actions button {
            padding: 8px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .bulk-actions button:hover {
            background: #f0f4ff;
        }
        
        .category-Miscellaneous { background: #e2e8f0; color: #4a5568; }
        .category-Unmarked { background: #f1f5f9; color: #64748b; }
        .category-Rent { background: #dbeafe; color: #1e40af; }
        .category-Housing { background: #bfdbfe; color: #1e3a8a; }
        .category-Utilities { background: #ede9fe; color: #5b21b6; }
        .category-Groceries { background: #d1fae5; color: #065f46; }
        .category-Transportation { background: #ccfbf1; color: #134e4a; }
        .category-Healthcare { background: #fef3c7; color: #78350f; }
        .category-Insurance { background: #fce7f3; color: #831843; }
        .category-DebtPayments { background: #fee2e2; color: #7f1d1d; }
        .category-SavingsInvestments { background: #d1fae5; color: #14532d; }
        .category-PersonalCare { background: #f3e8ff; color: #581c87; }
        .category-Pets { background: #fce7f3; color: #9f1239; }
        .category-DiningOut { background: #fed7aa; color: #7c2d12; }
        .category-Entertainment { background: #cffafe; color: #164e63; }
        .category-BusinessExpense { background: #dbeafe; color: #075985; }
        .category-Gifts { background: #fce7f3; color: #9f1239; }
        .category-Income { background: #d1fae5; color: #166534; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-content h3 {
            color: #2d3748;
            margin-bottom: 20px;
        }
        
        .category-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .category-option {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .category-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .category-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }
        
        .insight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .insight-box h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .insight-box ul {
            list-style: none;
            padding: 0;
        }
        
        .insight-box li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .insight-box li:last-child {
            border-bottom: none;
        }
        
        .momentum-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #e2e8f0;
        }
        
        .momentum-card.trending-up {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .momentum-card.trending-down {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .momentum-card.stable {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        
        .momentum-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .momentum-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
        }
        
        .momentum-indicator {
            font-size: 1.5rem;
        }
        
        .momentum-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 5px;
        }
        
        .momentum-change {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .seasonal-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .seasonal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .seasonal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .seasonal-stat {
            color: #4a5568;
            margin: 5px 0;
        }
        
        .forecast-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .forecast-month {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .forecast-amount {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .forecast-confidence {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .filter-indicator {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .budget-alert {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .budget-alert.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .budget-alert.danger {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .budget-alert.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            min-width: 300px;
            max-width: 450px;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        .notification.show {
            display: block;
        }
        
        .notification.success {
            border-left: 4px solid #10b981;
        }
        
        .notification.info {
            border-left: 4px solid #3b82f6;
        }
        
        .notification h4 {
            color: #2d3748;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .notification p {
            color: #718096;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .notification {
                right: 10px;
                left: 10px;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-section" id="uploadSection">
            <h1>💰 Advanced Financial Dashboard</h1>
            <p>Upload your bank transaction CSV files to unlock powerful insights</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".csv" multiple />
                <label for="fileInput" class="file-input-label">📊 Choose CSV File(s)</label>
            </div>
            <div class="upload-tip">
                <strong>💡 Pro Tip:</strong>
                <p>You can select multiple CSV files at once! Perfect for combining years of SoFi data into one complete view. Blank rows and invalid data will be automatically skipped.</p>
            </div>
            <div class="loading" id="loadingText" style="display: none;">
                Analyzing your financial data...
            </div>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="header">
                <div class="header-top">
                    <div>
                        <h1>Your Financial Command Center</h1>
                        <p id="dateRange"></p>
                    </div>
                    <div class="header-controls">
                        <div class="date-filter-container">
                            <span class="date-filter-label">📅 Time Period:</span>
                            <select class="date-filter-select" id="dateRangeFilter" onchange="handleDateFilterChange()">
                                <option value="all">All Time</option>
                                <option value="30">Last Month</option>
                                <option value="90">Last 3 Months</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            <div class="custom-date-inputs" id="customDateInputs">
                                <input type="date" class="date-input" id="startDate" />
                                <span style="color: #4a5568;">to</span>
                                <input type="date" class="date-input" id="endDate" />
                                <button class="apply-filter-btn" onclick="applyCustomDateFilter()">Apply</button>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="addMoreData()">➕ Add More Data</button>
                        <button class="btn btn-success" onclick="exportCSV()" id="exportBtn">📥 Export All</button>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('overview')">📊 Overview</button>
                    <button class="tab" onclick="switchTab('insights')">💡 Insights</button>
                    <button class="tab" onclick="switchTab('action')">🎯 Action Plan</button>
                    <button class="tab" onclick="switchTab('budget')">💵 Budget</button>
                    <button class="tab" onclick="switchTab('trends')">📈 Trends</button>
                    <button class="tab" onclick="switchTab('transactions')">📋 Transactions</button>
                </div>
            </div>

            <div id="overviewTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Current Balance</div>
                        <div class="stat-value" id="currentBalance" style="color: #4299e1;">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Income</div>
                        <div class="stat-value positive" id="totalIncome">$0</div>
                        <div class="stat-sub" id="avgIncome"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Expenses</div>
                        <div class="stat-value negative" id="totalExpenses">$0</div>
                        <div class="stat-sub" id="avgExpenses"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Savings Rate</div>
                        <div class="stat-value" id="savingsRate" style="color: #9f7aea;">0%</div>
                        <div class="stat-sub" id="netSavings"></div>
                    </div>
                </div>
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Spending by Category</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Monthly Trend</h3>
                        <canvas id="miniTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="insightsTab" class="tab-content" style="display: none;">
                <div class="insight-box">
                    <h3>🎯 Key Financial Insights</h3>
                    <ul id="insightsList"></ul>
                </div>
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Spending Breakdown</h3>
                        <canvas id="detailedCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Category Details</h3>
                        <div id="categoryDetailsList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <div id="actionTab" class="tab-content" style="display: none;">
                <div class="action-plan">
                    <h3 style="color: #2d3748; font-size: 1.8rem; margin-bottom: 30px;">📋 Your Personalized Action Plan</h3>
                    <div class="plan-section">
                        <h4>🚀 Short-term (Next 30 Days)</h4>
                        <div id="shortTermPlan"></div>
                    </div>
                    <div class="plan-section">
                        <h4>📅 Medium-term (Next 3 Months)</h4>
                        <div id="mediumTermPlan"></div>
                    </div>
                    <div class="plan-section">
                        <h4>🎯 Long-term (Next Year)</h4>
                        <div id="longTermPlan"></div>
                    </div>
                </div>
            </div>

            <div id="budgetTab" class="tab-content" style="display: none;">
                <div class="budget-section">
                    <h3 style="margin-bottom: 30px;">💵 Monthly Budget Planner</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Set your target budget for each category and track your progress</p>
                    <div id="budgetItems"></div>
                    <button class="btn btn-primary" onclick="saveBudget()" style="margin-top: 20px;">💾 Save Budget</button>
                </div>
                <div class="chart-container">
                    <h3>Budget vs Actual Spending</h3>
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>

            <div id="trendsTab" class="tab-content" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Monthly Trend</div>
                        <div class="stat-value" id="trendDirection" style="color: #4299e1;">--</div>
                        <div class="stat-sub" id="trendDetails"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Daily Avg Spending</div>
                        <div class="stat-value" id="dailyAvgSpending" style="color: #f59e0b;">$0</div>
                        <div class="stat-sub" id="dailyTrend"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Best Savings Month</div>
                        <div class="stat-value positive" id="bestMonth" style="font-size: 1.5rem;">--</div>
                        <div class="stat-sub" id="bestMonthAmount"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Spending Pattern</div>
                        <div class="stat-value" id="spendingPattern" style="color: #9f7aea; font-size: 1.5rem;">--</div>
                        <div class="stat-sub" id="patternDetails"></div>
                    </div>
                </div>
                <div class="insight-box" id="anomalyBox" style="display: none;">
                    <h3>⚠️ Unusual Activity Detected</h3>
                    <ul id="anomalyList"></ul>
                </div>
                <div class="chart-container">
                    <h3>📊 Category Momentum - What's Trending</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Compare your last 3 months vs previous 3 months to see spending trends</p>
                    <div id="categoryMomentumGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;"></div>
                </div>
                <div class="chart-container">
                    <h3>🌡️ Seasonal Spending Patterns</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Your spending patterns across different times of year</p>
                    <div id="seasonalInsights"></div>
                </div>
                <div class="chart-container">
                    <h3>Monthly Income vs Expenses</h3>
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Balance Over Time</h3>
                    <canvas id="balanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Spending Composition Over Time</h3>
                    <p style="color: #718096; margin-bottom: 15px;">See how your spending is distributed across categories each month</p>
                    <canvas id="categoryTrendChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>📅 Spending Heatmap - When Do You Spend Most?</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Darker colors indicate higher spending days</p>
                    <div id="spendingHeatmap"></div>
                </div>
                <div class="chart-container">
                    <h3>🔮 3-Month Forecast</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Based on your current spending trends</p>
                    <div id="forecastInsights"></div>
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>

            <div id="transactionsTab" class="tab-content" style="display: none;">
                <div class="transactions-table">
                    <h3>Transaction History & Tagging</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Click on category tags to recategorize transactions</p>
                    <div class="bulk-actions" id="bulkActions">
                        <span id="selectedCount">0 selected</span>
                        <button onclick="bulkRecategorize()">🏷️ Recategorize Selected</button>
                        <button onclick="clearSelection()">✕ Clear Selection</button>
                    </div>
                    <div class="filters">
                        <input type="text" class="filter-input" id="searchInput" placeholder="🔍 Search transactions..." />
                        <select class="filter-input" id="typeFilter">
                            <option value="all">All Types</option>
                        </select>
                        <select class="filter-input" id="categoryFilter">
                            <option value="all">All Categories</option>
                        </select>
                        <select class="filter-input" id="dateFilter">
                            <option value="all">All Time</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    <div class="table-scroll-container" id="tableScrollContainer">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;"><input type="checkbox" class="select-checkbox" id="selectAll" onchange="toggleSelectAll()" /></th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th style="text-align: right;">Amount</th>
                                    <th style="text-align: right;">Balance</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsBody"></tbody>
                            <tfoot>
                                <tr style="background: #f7fafc; font-weight: 600; border-top: 3px solid #667eea;">
                                    <td colspan="5" style="text-align: right; padding: 20px 15px; font-size: 1rem; color: #2d3748;">Filtered Totals:</td>
                                    <td style="text-align: right; padding: 20px 15px;">
                                        <div id="totalAmount" style="font-size: 1.1rem;"></div>
                                        <div id="totalBreakdown" style="font-size: 0.85rem; margin-top: 5px;"></div>
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <p id="transactionCount" style="margin-top: 15px; color: #718096; text-align: center;"></p>
                    <div id="loadingMore" style="text-align: center; padding: 20px; color: #718096; display: none;">Loading more transactions...</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="additionalFileInput" accept=".csv" multiple style="display: none;" />

    <div class="notification" id="notification">
        <h4 id="notificationTitle"></h4>
        <p id="notificationMessage"></p>
    </div>

    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <h3>Recategorize Transaction</h3>
            <p id="modalDescription" style="color: #718096; margin-bottom: 20px;"></p>
            <div class="category-options" id="categoryOptions"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveCategory()">Save</button>
                <button class="btn" style="background: #e2e8f0;" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let allTransactions = [];
        let filteredTransactionsByDate = [];
        let charts = {};
        let currentEditTransaction = null;
        let budgetTargets = {};
        let selectedTransactions = new Set();
        let displayedTransactionCount = 100;
        let filteredTransactionsList = [];
        let isLoadingMore = false;
        let loadedFilesCount = 0;

        const categories = ['Rent', 'Housing', 'Utilities', 'Groceries', 'Transportation', 'Healthcare', 'Insurance', 'Debt Payments', 'Savings & Investments', 'Personal Care', 'Pets', 'Dining Out', 'Entertainment', 'Business Expense', 'Gifts', 'Income', 'Miscellaneous', 'Unmarked'];
        const categoryColors = {
            'Rent': '#2563eb', 'Housing': '#3b82f6', 'Utilities': '#8b5cf6', 'Groceries': '#10b981',
            'Transportation': '#14b8a6', 'Healthcare': '#f59e0b', 'Insurance': '#ec4899',
            'Debt Payments': '#ef4444', 'Savings & Investments': '#10b981', 'Personal Care': '#a855f7',
            'Pets': '#ec4899', 'Dining Out': '#f97316', 'Entertainment': '#06b6d4',
            'Business Expense': '#0ea5e9', 'Gifts': '#f472b6', 'Income': '#22c55e',
            'Miscellaneous': '#6b7280', 'Unmarked': '#94a3b8'
        };

        // Check if PapaParse is loaded
        console.log('Papa Parse loaded:', typeof Papa !== 'undefined');
        console.log('Script initialized');

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('additionalFileInput').addEventListener('change', handleAdditionalFiles);
        document.getElementById('searchInput').addEventListener('input', filterTransactions);
        document.getElementById('typeFilter').addEventListener('change', filterTransactions);
        document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
        document.getElementById('dateFilter').addEventListener('change', filterTransactions);

        function handleFileUpload(e) {
            console.log('File upload triggered', e.target.files);
            const files = e.target.files;
            if (!files || files.length === 0) {
                console.log('No files selected');
                return;
            }
            
            document.getElementById('loadingText').style.display = 'block';
            loadedFilesCount = files.length;
            
            try {
                processMultipleFiles(files, true);
            } catch (error) {
                console.error('Error processing files:', error);
                showNotification('Upload Error', 'There was an error processing your files. Please try again.', 'info');
                document.getElementById('loadingText').style.display = 'none';
            }
        }

        function addMoreData() {
            document.getElementById('additionalFileInput').click();
        }

        function handleAdditionalFiles(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            loadedFilesCount = files.length;
            showNotification('Processing Files...', 'Analyzing ' + files.length + ' file(s) and detecting duplicates...', 'info');
            
            try {
                processMultipleFiles(files, false);
            } catch (error) {
                console.error('Error processing additional files:', error);
                showNotification('Upload Error', 'There was an error processing your files. Please try again.', 'info');
            }
        }

        function processMultipleFiles(files, isInitialLoad) {
            let allNewTransactions = [];
            let filesProcessed = 0;
            let totalRowsSkipped = 0;
            
            Array.from(files).forEach((file, index) => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        let validTransactions = [];
                        let skippedRows = 0;
                        
                        results.data.forEach((row) => {
                            const cleaned = {};
                            Object.keys(row).forEach(key => {
                                cleaned[key.trim()] = row[key];
                            });
                            
                            const hasDate = cleaned.Date && cleaned.Date.toString().trim() !== '';
                            const hasDescription = cleaned.Description && cleaned.Description.toString().trim() !== '';
                            const hasAmount = cleaned.Amount !== null && cleaned.Amount !== undefined && cleaned.Amount !== '';
                            const hasBalance = cleaned['Current balance'] !== null && cleaned['Current balance'] !== undefined && cleaned['Current balance'] !== '';
                            
                            if (hasDate && hasDescription && hasAmount && hasBalance) {
                                cleaned.CustomCategory = cleaned.CustomCategory || null;
                                validTransactions.push(cleaned);
                            } else {
                                skippedRows++;
                            }
                        });
                        
                        totalRowsSkipped += skippedRows;
                        allNewTransactions = allNewTransactions.concat(validTransactions);
                        filesProcessed++;
                        
                        if (filesProcessed === files.length) {
                            finalizeMerge(allNewTransactions, isInitialLoad, totalRowsSkipped);
                        }
                    },
                    error: function(error) {
                        console.error('Error parsing file:', file.name, error);
                        showNotification('File Error', 'Could not parse ' + file.name + '. Please check the file format.', 'info');
                        filesProcessed++;
                        
                        if (filesProcessed === files.length) {
                            finalizeMerge(allNewTransactions, isInitialLoad, totalRowsSkipped);
                        }
                    }
                });
            });
        }

        function finalizeMerge(newTransactions, isInitialLoad, rowsSkipped) {
            if (newTransactions.length === 0) {
                showNotification('No Valid Data Found', 'The selected file(s) did not contain any valid transactions. Please check your CSV format.', 'info');
                document.getElementById('loadingText').style.display = 'none';
                return;
            }
            
            if (isInitialLoad) {
                allTransactions = newTransactions;
            } else {
                const beforeCount = allTransactions.length;
                const newCount = newTransactions.length;
                
                allTransactions = mergeAndDeduplicateTransactions(allTransactions, newTransactions);
                
                const afterCount = allTransactions.length;
                const duplicatesRemoved = (beforeCount + newCount) - afterCount;
                const actuallyAdded = afterCount - beforeCount;
                
                let message = 'Added ' + actuallyAdded + ' new transaction(s).';
                if (duplicatesRemoved > 0) {
                    message += ' Removed ' + duplicatesRemoved + ' duplicate(s).';
                }
                if (rowsSkipped > 0) {
                    message += ' Skipped ' + rowsSkipped + ' invalid row(s).';
                }
                message += ' Total: ' + afterCount + ' transactions.';
                
                showNotification('Data Merged Successfully! 🎉', message, 'success');
            }
            
            allTransactions.sort((a, b) => new Date(a.Date) - new Date(b.Date));
            allTransactions.forEach((t, idx) => {
                t._id = idx;
            });
            
            filteredTransactionsByDate = [...allTransactions];
            
            if (allTransactions.length > 0) {
                const minDate = new Date(allTransactions[0].Date);
                const maxDate = new Date(allTransactions[allTransactions.length - 1].Date);
                document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
            }
            
            processData();
            
            if (isInitialLoad) {
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                
                let initialMessage = 'Successfully loaded ' + loadedFilesCount + ' CSV file(s) with ' + allTransactions.length + ' transactions.';
                if (rowsSkipped > 0) {
                    initialMessage += ' Skipped ' + rowsSkipped + ' invalid row(s).';
                }
                
                if (loadedFilesCount > 1 || rowsSkipped > 0) {
                    showNotification('Files Loaded! 🎉', initialMessage, 'success');
                }
            }
            
            document.getElementById('additionalFileInput').value = '';
        }

        function mergeAndDeduplicateTransactions(existing, newOnes) {
            const combined = [...existing, ...newOnes];
            
            const seen = new Map();
            const unique = [];
            
            combined.forEach(transaction => {
                const key = transaction.Date + '|' + 
                           transaction.Description + '|' + 
                           transaction.Amount + '|' + 
                           transaction['Current balance'];
                
                if (!seen.has(key)) {
                    seen.set(key, true);
                    unique.push(transaction);
                }
            });
            
            return unique;
        }

        function showNotification(title, message, type) {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            notification.className = 'notification show ' + type;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function handleDateFilterChange() {
            const filterValue = document.getElementById('dateRangeFilter').value;
            const customInputs = document.getElementById('customDateInputs');
            if (filterValue === 'custom') {
                customInputs.classList.add('active');
                return;
            } else {
                customInputs.classList.remove('active');
            }
            if (filterValue === 'all') {
                filteredTransactionsByDate = [...allTransactions];
            } else {
                const days = parseInt(filterValue);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                filteredTransactionsByDate = allTransactions.filter(t => new Date(t.Date) >= cutoffDate);
            }
            processData();
        }

        function applyCustomDateFilter() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            if (!startDate || !endDate) { alert('Please select both start and end dates'); return; }
            if (startDate > endDate) { alert('Start date must be before end date'); return; }
            const daysDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
            if (daysDiff < 30) { alert('Date range must be at least 1 month (30 days)'); return; }
            filteredTransactionsByDate = allTransactions.filter(t => {
                const transDate = new Date(t.Date);
                return transDate >= startDate && transDate <= endDate;
            });
            if (filteredTransactionsByDate.length === 0) {
                alert('No transactions found in the selected date range');
                filteredTransactionsByDate = [...allTransactions];
                return;
            }
            processData();
        }

        function categorizeTransaction(transaction) {
            if (transaction.CustomCategory) return transaction.CustomCategory;
            
            const desc = (transaction.Description || '').toString().toUpperCase();
            const amount = parseFloat(transaction.Amount) || 0;
            
            if (amount > 0) {
                if (desc.includes('DEPOSIT') || desc.includes('PAYROLL') || desc.includes('DIRECT DEPOSIT') ||
                    desc.includes('SALARY') || desc.includes('PAYCHECK') || desc.includes('PAYMENT FROM') ||
                    desc.includes('ACH CREDIT') || desc.includes('REFUND') || desc.includes('REIMBURSEMENT') ||
                    desc.includes('INTEREST EARNED') || desc.includes('DIVIDEND') || desc.includes('BONUS')) {
                    return 'Income';
                }
            }
            if (desc.includes('BUSINESS') || desc.includes('OFFICE SUPPLY') || desc.includes('STAPLES') ||
                desc.includes('OFFICE DEPOT') || desc.includes('FEDEX OFFICE') || desc.includes('UPS STORE') ||
                desc.includes('LINKEDIN') || desc.includes('QUICKBOOKS') || desc.includes('ADOBE') ||
                desc.includes('MICROSOFT 365') || desc.includes('ZOOM') || desc.includes('SLACK') ||
                desc.includes('DROPBOX') || desc.includes('DOMAIN') || desc.includes('HOSTING') ||
                desc.includes('AWS') || desc.includes('GOOGLE WORKSPACE') || desc.includes('PROFESSIONAL')) {
                return 'Business Expense';
            }
            if (desc.includes('GIFT') || desc.includes('FLOWERS') || desc.includes('FTDS') ||
                desc.includes('1-800-FLOWERS') || desc.includes('EDIBLE ARRANGEMENTS') ||
                desc.includes('HALLMARK') || desc.includes('CARD STORE') || desc.includes('TOY STORE') ||
                desc.includes('TOYS R US') || desc.includes('BUILD-A-BEAR') || desc.includes('CHARITABLE') ||
                desc.includes('DONATION') || desc.includes('CHARITY') || desc.includes('GIVING')) {
                return 'Gifts';
            }
            if (desc.includes('RENT') || desc.includes('APARTMENT') || desc.includes('LANDLORD')) return 'Rent';
            if (desc.includes('MORTGAGE') || desc.includes('PROPERTY TAX') || desc.includes('HOA') ||
                desc.includes('U-HAUL') || desc.includes('STORAGE') || desc.includes('HOME DEPOT') ||
                desc.includes('LOWES') || desc.includes('HOME REPAIR') || desc.includes('HOMEOWNERS') ||
                desc.includes('PROPERTY INSURANCE')) return 'Housing';
            if (desc.includes('ELECTRIC') || desc.includes('POWER') || desc.includes('UTILITY') ||
                desc.includes('WATER') || desc.includes('GAS COMPANY') || desc.includes('INTERNET') ||
                desc.includes('COMCAST') || desc.includes('VERIZON') || desc.includes('ATT') ||
                desc.includes('T-MOBILE') || desc.includes('SPRINT') || desc.includes('SPECTRUM') ||
                desc.includes('INMOTION') || desc.includes('PHONE') || desc.includes('CABLE') ||
                desc.includes('XFINITY') || desc.includes('COX') || desc.includes('FRONTIER')) return 'Utilities';
            if (desc.includes('HANNAFORD') || desc.includes('SHAWS') || desc.includes('WALMART') ||
                desc.includes('TARGET') || desc.includes('COSTCO') || desc.includes('SAMS CLUB') ||
                desc.includes('WHOLE FOODS') || desc.includes('TRADER JOE') || desc.includes('ALDI') ||
                desc.includes('KROGER') || desc.includes('PUBLIX') || desc.includes('SAFEWAY') ||
                desc.includes('GROCERY') || desc.includes('SUPERMARKET') || desc.includes('FOOD LION') ||
                desc.includes('WEGMANS') || desc.includes('STOP & SHOP')) return 'Groceries';
            if (desc.includes('RESTAURANT') || desc.includes('PIZZA') || desc.includes('CAFE') ||
                desc.includes('COFFEE') || desc.includes('DUNKIN') || desc.includes('STARBUCKS') ||
                desc.includes('MCDONALDS') || desc.includes('BURGER') || desc.includes('TACO') ||
                desc.includes('SUBWAY') || desc.includes('CHIPOTLE') || desc.includes('PANERA') ||
                desc.includes('BAGEL') || desc.includes('DOORDASH') || desc.includes('UBER EATS') ||
                desc.includes('GRUBHUB') || desc.includes('DELIVERY') || desc.includes('DINE') ||
                desc.includes('WENDYS') || desc.includes('CHICK-FIL-A') || desc.includes('DOMINOS')) return 'Dining Out';
            if (desc.includes('GAS') || desc.includes('FUEL') || desc.includes('SHELL') ||
                desc.includes('EXXON') || desc.includes('MOBIL') || desc.includes('CHEVRON') ||
                desc.includes('BP ') || desc.includes('SUNOCO') || desc.includes('AUTO PAYMENT') ||
                desc.includes('CAR PAYMENT') || desc.includes('UBER') || desc.includes('LYFT') ||
                desc.includes('TRANSIT') || desc.includes('PARKING') || desc.includes('TOLL') ||
                desc.includes('AAA ') || desc.includes('JIFFY LUBE') || desc.includes('MIDAS') ||
                desc.includes('AUTO REPAIR') || desc.includes('MECHANIC') || desc.includes('DMV') ||
                desc.includes('VALVOLINE') || desc.includes('PEP BOYS')) return 'Transportation';
            if (desc.includes('HOSPITAL') || desc.includes('MEDICAL') || desc.includes('DOCTOR') ||
                desc.includes('DENTAL') || desc.includes('DENTIST') || desc.includes('VISION') ||
                desc.includes('PHARMACY') || desc.includes('CVS') || desc.includes('WALGREENS') ||
                desc.includes('RITE AID') || desc.includes('PRESCRIPTION') || desc.includes('CLINIC') ||
                desc.includes('HEALTH') || desc.includes('URGENT CARE') || desc.includes('THERAPY') ||
                desc.includes('CHIROPRACTOR') || desc.includes('PHYSICAL THERAPY')) return 'Healthcare';
            if (desc.includes('INSURANCE') || desc.includes('GEICO') || desc.includes('STATE FARM') ||
                desc.includes('PROGRESSIVE') || desc.includes('ALLSTATE') || desc.includes('USAA') ||
                desc.includes('LIBERTY MUTUAL') || desc.includes('PREMIUM') || desc.includes('FARMERS INS')) return 'Insurance';
            if (desc.includes('CREDIT CARD PAYMENT') || desc.includes('LOAN PAYMENT') ||
                desc.includes('STUDENT LOAN') || desc.includes('NELNET') || desc.includes('NAVIENT') ||
                desc.includes('GREAT LAKES') || desc.includes('PAYMENT TO CHASE') ||
                desc.includes('PAYMENT TO CITI') || desc.includes('PAYMENT TO DISCOVER') ||
                desc.includes('PAYMENT TO CAPITAL ONE') || desc.includes('PAYMENT TO AMEX')) return 'Debt Payments';
            if (desc.includes('SAVINGS') || desc.includes('INVESTMENT') || desc.includes('401K') ||
                desc.includes('IRA') || desc.includes('FIDELITY') || desc.includes('VANGUARD') ||
                desc.includes('SCHWAB') || desc.includes('ROBINHOOD') || desc.includes('BETTERMENT') ||
                desc.includes('WEALTHFRONT') || desc.includes('E*TRADE') || desc.includes('TD AMERITRADE') ||
                (amount < 0 && desc.includes('TRANSFER TO SAVINGS'))) return 'Savings & Investments';
            if (desc.includes('SALON') || desc.includes('BARBER') || desc.includes('HAIRCUT') ||
                desc.includes('SPA') || desc.includes('GYM') || desc.includes('FITNESS') ||
                desc.includes('PLANET FITNESS') || desc.includes('LA FITNESS') || desc.includes('YMCA') ||
                desc.includes('CLOTHING') || desc.includes('APPAREL') || desc.includes('FOOTWEAR') ||
                desc.includes('NIKE') || desc.includes('ADIDAS') || desc.includes('KOHLS') ||
                desc.includes('MACYS') || desc.includes('NORDSTROM') || desc.includes('SEPHORA') ||
                desc.includes('ULTA') || desc.includes('OLD NAVY') || desc.includes('GAP')) return 'Personal Care';
            if (desc.includes('PET') || desc.includes('VET') || desc.includes('VETERINAR') ||
                desc.includes('PETSMART') || desc.includes('PETCO') || desc.includes('CHEWY') ||
                desc.includes('DOG') || desc.includes('CAT') || desc.includes('ANIMAL HOSPITAL') ||
                desc.includes('PET SUPPLIES') || desc.includes('GROOMING') || desc.includes('PUPPY') ||
                desc.includes('KITTEN') || desc.includes('PET FOOD')) return 'Pets';
            if (desc.includes('NETFLIX') || desc.includes('HULU') || desc.includes('DISNEY') ||
                desc.includes('SPOTIFY') || desc.includes('APPLE MUSIC') || desc.includes('HBO') ||
                desc.includes('AMAZON PRIME') || desc.includes('MOVIE') || desc.includes('THEATER') ||
                desc.includes('CINEMA') || desc.includes('CONCERT') || desc.includes('TICKET') ||
                desc.includes('STEAM') || desc.includes('PLAYSTATION') || desc.includes('XBOX') ||
                desc.includes('NINTENDO') || desc.includes('HOBBY') || desc.includes('BEST BUY') ||
                desc.includes('GAMESTOP') || desc.includes('AMC THEATERS') || desc.includes('REGAL')) return 'Entertainment';
            if (desc.includes('AMAZON') || desc.includes('AMZN')) return 'Miscellaneous';
            if (desc.includes('VENMO') || desc.includes('PAYPAL') || desc.includes('ZELLE') ||
                desc.includes('CASH APP') || desc.includes('CHECK')) return 'Miscellaneous';
            if (desc.includes('USPS') || desc.includes('FEDEX') || desc.includes('UPS')) return 'Miscellaneous';
            return 'Unmarked';
        }

        function processData() {
            try {
                const analytics = calculateAnalytics();
                updateStats(analytics);
                createCharts(analytics);
                generateInsights(analytics);
                generateActionPlan(analytics);
                createBudgetSection(analytics);
                generateTrendAnalysis(analytics);
                populateTransactions();
                populateFilters();
            } catch (error) {
                console.error('Error processing data:', error);
                showNotification('Processing Error', 'There was an error analyzing your data. Some features may not work correctly.', 'info');
            }
        }

        function calculateAnalytics() {
            const transactionsToAnalyze = filteredTransactionsByDate;
            
            if (!transactionsToAnalyze || transactionsToAnalyze.length === 0) {
                return {
                    totalIncome: 0,
                    totalExpenses: 0,
                    currentBalance: 0,
                    monthlyTrends: [],
                    categoryData: [],
                    categoryDetails: {},
                    avgMonthlyIncome: 0,
                    avgMonthlyExpenses: 0
                };
            }
            
            transactionsToAnalyze.forEach(t => { t.Category = categorizeTransaction(t); });
            
            const totalIncome = transactionsToAnalyze.filter(t => t.Amount > 0).reduce((sum, t) => sum + (parseFloat(t.Amount) || 0), 0);
            const totalExpenses = Math.abs(transactionsToAnalyze.filter(t => t.Amount < 0).reduce((sum, t) => sum + (parseFloat(t.Amount) || 0), 0));
            const currentBalance = transactionsToAnalyze[transactionsToAnalyze.length - 1]?.['Current balance'] || 0;
            
            const monthlyData = {};
            transactionsToAnalyze.forEach(t => {
                try {
                    const date = new Date(t.Date);
                    const key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                    if (!monthlyData[key]) {
                        monthlyData[key] = { month: key, income: 0, expenses: 0, balance: 0, categories: {} };
                    }
                    const amount = parseFloat(t.Amount) || 0;
                    if (amount > 0) {
                        monthlyData[key].income += amount;
                    } else {
                        monthlyData[key].expenses += Math.abs(amount);
                        const cat = t.Category;
                        if (!monthlyData[key].categories[cat]) monthlyData[key].categories[cat] = 0;
                        monthlyData[key].categories[cat] += Math.abs(amount);
                    }
                    monthlyData[key].balance = parseFloat(t['Current balance']) || 0;
                } catch (error) {
                    console.error('Error processing transaction:', t, error);
                }
            });
            
            const monthlyTrends = Object.values(monthlyData).sort((a, b) => a.month.localeCompare(b.month));
            const categoryData = {};
            const categoryDetails = {};
            transactionsToAnalyze.filter(t => t.Amount < 0).forEach(t => {
                const cat = t.Category;
                if (!categoryData[cat]) {
                    categoryData[cat] = 0;
                    categoryDetails[cat] = [];
                }
                categoryData[cat] += Math.abs(parseFloat(t.Amount) || 0);
                categoryDetails[cat].push({ description: t.Description, amount: Math.abs(parseFloat(t.Amount) || 0), date: t.Date });
            });
            const categoryArray = Object.entries(categoryData).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
            return {
                totalIncome, totalExpenses, currentBalance, monthlyTrends, categoryData: categoryArray, categoryDetails,
                avgMonthlyIncome: monthlyTrends.length > 0 ? totalIncome / monthlyTrends.length : 0,
                avgMonthlyExpenses: monthlyTrends.length > 0 ? totalExpenses / monthlyTrends.length : 0
            };
        }

        function updateStats(analytics) {
            if (!filteredTransactionsByDate || filteredTransactionsByDate.length === 0) {
                document.getElementById('dateRange').innerHTML = 'No transactions loaded';
                document.getElementById('currentBalance').textContent = '$0';
                document.getElementById('totalIncome').textContent = '$0';
                document.getElementById('avgIncome').textContent = 'Avg: $0/mo';
                document.getElementById('totalExpenses').textContent = '$0';
                document.getElementById('avgExpenses').textContent = 'Avg: $0/mo';
                document.getElementById('savingsRate').textContent = '0%';
                document.getElementById('netSavings').textContent = 'Net: $0';
                return;
            }
            
            try {
                const firstDate = new Date(filteredTransactionsByDate[0].Date).toLocaleDateString();
                const lastDate = new Date(filteredTransactionsByDate[filteredTransactionsByDate.length - 1].Date).toLocaleDateString();
                const filterIndicator = filteredTransactionsByDate.length < allTransactions.length ? '<span class="filter-indicator">📊 Filtered: ' + filteredTransactionsByDate.length + ' of ' + allTransactions.length + ' transactions</span>' : '';
                document.getElementById('dateRange').innerHTML = firstDate + ' - ' + lastDate + ' ' + filterIndicator;
                document.getElementById('currentBalance').textContent = '$' + analytics.currentBalance.toLocaleString();
                document.getElementById('totalIncome').textContent = '$' + analytics.totalIncome.toLocaleString();
                document.getElementById('avgIncome').textContent = 'Avg: $' + Math.round(analytics.avgMonthlyIncome).toLocaleString() + '/mo';
                document.getElementById('totalExpenses').textContent = '$' + analytics.totalExpenses.toLocaleString();
                document.getElementById('avgExpenses').textContent = 'Avg: $' + Math.round(analytics.avgMonthlyExpenses).toLocaleString() + '/mo';
                const savingsRate = analytics.totalIncome > 0 ? ((analytics.totalIncome - analytics.totalExpenses) / analytics.totalIncome * 100).toFixed(1) : 0;
                document.getElementById('savingsRate').textContent = savingsRate + '%';
                document.getElementById('netSavings').textContent = 'Net: $' + Math.round(analytics.totalIncome - analytics.totalExpenses).toLocaleString();
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        function createCharts(analytics) {
            if (charts.categoryChart) charts.categoryChart.destroy();
            charts.categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: analytics.categoryData.map(c => c.name),
                    datasets: [{ data: analytics.categoryData.map(c => c.value), backgroundColor: analytics.categoryData.map(c => categoryColors[c.name] || '#6b7280') }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
            if (charts.miniTrendChart) charts.miniTrendChart.destroy();
            charts.miniTrendChart = new Chart(document.getElementById('miniTrendChart'), {
                type: 'line',
                data: {
                    labels: analytics.monthlyTrends.slice(-6).map(m => m.month),
                    datasets: [{ label: 'Balance', data: analytics.monthlyTrends.slice(-6).map(m => m.balance), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
            if (charts.detailedCategoryChart) charts.detailedCategoryChart.destroy();
            charts.detailedCategoryChart = new Chart(document.getElementById('detailedCategoryChart'), {
                type: 'bar',
                data: {
                    labels: analytics.categoryData.map(c => c.name),
                    datasets: [{ label: 'Spending', data: analytics.categoryData.map(c => c.value), backgroundColor: analytics.categoryData.map(c => categoryColors[c.name] || '#6b7280') }]
                },
                options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
            const detailsHtml = analytics.categoryData.map(cat => {
                const details = analytics.categoryDetails[cat.name] || [];
                const avgTransaction = cat.value / details.length;
                return '<div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 10px;"><div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><strong style="color: #2d3748;">' + cat.name + '</strong><strong style="color: ' + categoryColors[cat.name] + ';">$' + cat.value.toLocaleString() + '</strong></div><div style="color: #718096; font-size: 0.9rem;">' + details.length + ' transactions | Avg: $' + avgTransaction.toFixed(2) + '</div></div>';
            }).join('');
            document.getElementById('categoryDetailsList').innerHTML = detailsHtml;
            if (charts.monthlyChart) charts.monthlyChart.destroy();
            charts.monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                type: 'line',
                data: {
                    labels: analytics.monthlyTrends.map(m => m.month),
                    datasets: [
                        { label: 'Income', data: analytics.monthlyTrends.map(m => m.income), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 },
                        { label: 'Expenses', data: analytics.monthlyTrends.map(m => m.expenses), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
            if (charts.balanceChart) charts.balanceChart.destroy();
            charts.balanceChart = new Chart(document.getElementById('balanceChart'), {
                type: 'line',
                data: {
                    labels: analytics.monthlyTrends.map(m => m.month),
                    datasets: [{ label: 'Balance', data: analytics.monthlyTrends.map(m => m.balance), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
            const topCategories = analytics.categoryData.slice(0, 6);
            const categoryTrendDatasets = topCategories.map(cat => {
                const data = analytics.monthlyTrends.map(month => month.categories[cat.name] || 0);
                return {
                    label: cat.name, data: data, borderColor: categoryColors[cat.name] || '#6b7280',
                    backgroundColor: categoryColors[cat.name] ? categoryColors[cat.name] + '80' : '#6b728080', fill: true, tension: 0.4
                };
            });
            if (charts.categoryTrendChart) charts.categoryTrendChart.destroy();
            charts.categoryTrendChart = new Chart(document.getElementById('categoryTrendChart'), {
                type: 'line',
                data: { labels: analytics.monthlyTrends.map(m => m.month), datasets: categoryTrendDatasets },
                options: {
                    responsive: true, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': $' + context.parsed.y.toLocaleString(); } } } },
                    scales: { y: { stacked: true, ticks: { callback: function(value) { return '$' + value.toLocaleString(); } } }, x: { stacked: true } }
                }
            });
        }

        function generateInsights(analytics) {
            const insights = [];
            if (analytics.totalIncome === 0 && analytics.totalExpenses === 0) {
                insights.push('No transaction data available for the selected time period.');
                document.getElementById('insightsList').innerHTML = insights.map(i => '<li>' + i + '</li>').join('');
                return;
            }
            const savingsRate = analytics.totalIncome > 0 ? ((analytics.totalIncome - analytics.totalExpenses) / analytics.totalIncome * 100) : 0;
            if (savingsRate < 10) {
                insights.push('Your current savings rate is <strong>' + savingsRate.toFixed(1) + '%</strong>. Financial experts recommend <strong>15-20%</strong> for healthy financial growth.');
            } else if (savingsRate >= 20) {
                insights.push('✅ Excellent! Your <strong>' + savingsRate.toFixed(1) + '%</strong> savings rate exceeds the recommended 15-20%. Keep up the great work!');
            } else {
                insights.push('Good progress! Your <strong>' + savingsRate.toFixed(1) + '%</strong> savings rate is on track. Push toward <strong>20%</strong> for optimal financial health.');
            }
            if (analytics.categoryData.length > 0) {
                const topCategory = analytics.categoryData[0];
                const topPercent = (topCategory.value / analytics.totalExpenses * 100).toFixed(1);
                insights.push('Your highest spending category is <strong>"' + topCategory.name + '"</strong> at <strong>$' + topCategory.value.toLocaleString() + '</strong> (' + topPercent + '% of expenses).');
            }
            const rentCategory = analytics.categoryData.find(c => c.name === 'Rent');
            const housingCategory = analytics.categoryData.find(c => c.name === 'Housing');
            const totalHousingCost = (rentCategory?.value || 0) + (housingCategory?.value || 0);
            if (totalHousingCost > 0) {
                const housingPercent = (totalHousingCost / analytics.totalIncome * 100);
                if (housingPercent > 35) {
                    insights.push('⚠️ Your total housing costs are <strong>' + housingPercent.toFixed(1) + '%</strong> of income (<strong>$' + totalHousingCost.toLocaleString() + '</strong>). Experts recommend keeping housing under <strong>30-35%</strong>.');
                } else if (housingPercent < 25) {
                    insights.push('✅ Great job! Your housing costs are only <strong>' + housingPercent.toFixed(1) + '%</strong> of income, well below the 30-35% guideline.');
                }
            }
            const transportCategory = analytics.categoryData.find(c => c.name === 'Transportation');
            if (transportCategory) {
                const transportPercent = (transportCategory.value / analytics.totalIncome * 100);
                if (transportPercent > 15) {
                    insights.push('⚠️ Your transportation costs are <strong>' + transportPercent.toFixed(1) + '%</strong> of income (<strong>$' + transportCategory.value.toLocaleString() + '</strong>). Consider ways to reduce this below <strong>15%</strong>.');
                }
            }
            const monthlyIncrease = analytics.monthlyTrends.length > 1 ? ((analytics.monthlyTrends[analytics.monthlyTrends.length - 1].expenses - analytics.monthlyTrends[analytics.monthlyTrends.length - 2].expenses) / analytics.monthlyTrends[analytics.monthlyTrends.length - 2].expenses * 100) : 0;
            if (monthlyIncrease > 10) {
                insights.push('⚠️ Your expenses increased by <strong>' + monthlyIncrease.toFixed(1) + '%</strong> last month. Review your recent spending.');
            } else if (monthlyIncrease < -10) {
                insights.push('✅ Excellent! Your expenses decreased by <strong>' + Math.abs(monthlyIncrease).toFixed(1) + '%</strong> last month.');
            }
            if (analytics.currentBalance < analytics.avgMonthlyExpenses * 3) {
                const targetFund = (analytics.avgMonthlyExpenses * 3).toFixed(0);
                insights.push('💰 Build your emergency fund to at least <strong>$' + parseFloat(targetFund).toLocaleString() + '</strong> (3 months of expenses).');
            } else if (analytics.currentBalance >= analytics.avgMonthlyExpenses * 6) {
                insights.push('✅ Excellent! You have <strong>' + (analytics.currentBalance / analytics.avgMonthlyExpenses).toFixed(1) + ' months</strong> of expenses saved.');
            }
            const miscCategory = analytics.categoryData.find(c => c.name === 'Miscellaneous');
            const unmarkedCategory = analytics.categoryData.find(c => c.name === 'Unmarked');
            const miscAndUnmarkedTotal = (miscCategory?.value || 0) + (unmarkedCategory?.value || 0);
            if (miscAndUnmarkedTotal > analytics.totalExpenses * 0.15) {
                const percentUncategorized = (miscAndUnmarkedTotal / analytics.totalExpenses * 100).toFixed(1);
                insights.push('📊 <strong>' + percentUncategorized + '%</strong> of your spending (<strong>$' + miscAndUnmarkedTotal.toLocaleString() + '</strong>) is "Miscellaneous" or "Unmarked". Use the Transactions tab to recategorize these for better insights.');
            }
            const diningCategory = analytics.categoryData.find(c => c.name === 'Dining Out');
            const groceryCategory = analytics.categoryData.find(c => c.name === 'Groceries');
            if (diningCategory && groceryCategory && diningCategory.value > groceryCategory.value * 0.5) {
                insights.push('🍽️ You\'re spending <strong>$' + diningCategory.value.toLocaleString() + '</strong> on dining out vs <strong>$' + groceryCategory.value.toLocaleString() + '</strong> on groceries. Cooking more at home could save significantly.');
            }
            document.getElementById('insightsList').innerHTML = insights.map(i => '<li>' + i + '</li>').join('');
        }

        function generateActionPlan(analytics) {
            const shortTerm = [], mediumTerm = [], longTerm = [];
            const savingsRate = analytics.totalIncome > 0 ? ((analytics.totalIncome - analytics.totalExpenses) / analytics.totalIncome * 100) : 0;
            const topSpending = analytics.categoryData[0];
            const rentCategory = analytics.categoryData.find(c => c.name === 'Rent');
            const housingCategory = analytics.categoryData.find(c => c.name === 'Housing');
            const totalHousingCost = (rentCategory?.value || 0) + (housingCategory?.value || 0);
            if (analytics.monthlyTrends.length > 0 && totalHousingCost / (analytics.totalIncome / analytics.monthlyTrends.length) > 0.35) {
                if (rentCategory) {
                    shortTerm.push({ text: 'Your rent exceeds 35% of income. Consider: getting a roommate, moving to a lower-cost area, or negotiating with landlord', impact: 'Reduce to 30%' });
                } else if (housingCategory) {
                    shortTerm.push({ text: 'Your housing costs exceed 35% of income. Explore options: refinance mortgage, reduce maintenance costs, or downsize', impact: 'Reduce to 30%' });
                }
            }
            if (topSpending && topSpending.name === 'Dining Out' && analytics.monthlyTrends.length > 0) {
                const avgPerMonth = topSpending.value / analytics.monthlyTrends.length;
                shortTerm.push({ text: 'Reduce dining out frequency by half and meal prep at home more often', impact: 'Save $' + Math.round(avgPerMonth * 0.5) + '/mo' });
            }
            const utilitiesCategory = analytics.categoryData.find(c => c.name === 'Utilities');
            if (utilitiesCategory && analytics.monthlyTrends.length > 0) {
                const avgMonthly = utilitiesCategory.value / analytics.monthlyTrends.length;
                if (avgMonthly > 300) {
                    shortTerm.push({ text: 'Call internet, phone, and cable providers to negotiate better rates or switch plans', impact: 'Save $50-100/mo' });
                }
            }
            const insuranceCategory = analytics.categoryData.find(c => c.name === 'Insurance');
            if (insuranceCategory) {
                shortTerm.push({ text: 'Shop around for insurance quotes (auto, home, life) - many people overpay by staying with same provider', impact: 'Save $30-80/mo' });
            }
            if (savingsRate < 15) {
                const targetSavings = (analytics.avgMonthlyIncome * 0.15);
                const currentSavings = analytics.avgMonthlyIncome - analytics.avgMonthlyExpenses;
                const gap = targetSavings - currentSavings;
                shortTerm.push({ text: 'Set up automatic transfer of $' + Math.round(gap) + '/mo to savings account on payday', impact: 'Reach 15% savings rate' });
            }
            const debtCategory = analytics.categoryData.find(c => c.name === 'Debt Payments');
            if (debtCategory) {
                mediumTerm.push({ text: 'List all debts by interest rate and create a debt payoff plan (avalanche method)', impact: 'Save on interest' });
            }
            if (analytics.currentBalance < analytics.avgMonthlyExpenses * 3) {
                mediumTerm.push({ text: 'Build emergency fund to $' + (analytics.avgMonthlyExpenses * 6).toFixed(0) + ' (6 months of expenses)', impact: 'Financial security' });
            }
            const healthcareCategory = analytics.categoryData.find(c => c.name === 'Healthcare');
            if (healthcareCategory && analytics.monthlyTrends.length > 0 && healthcareCategory.value / analytics.monthlyTrends.length > 200) {
                mediumTerm.push({ text: 'Review health insurance plan options during open enrollment for better coverage or lower costs', impact: 'Save $50-200/mo' });
            }
            const entertainmentCategory = analytics.categoryData.find(c => c.name === 'Entertainment');
            if (entertainmentCategory) {
                mediumTerm.push({ text: 'Audit all streaming services and subscriptions - cancel unused ones, share accounts with family', impact: 'Save $30-80/mo' });
            }
            const transportCategory = analytics.categoryData.find(c => c.name === 'Transportation');
            if (transportCategory && analytics.monthlyTrends.length > 0 && transportCategory.value / (analytics.totalIncome / analytics.monthlyTrends.length) > 0.15) {
                mediumTerm.push({ text: 'Evaluate transportation costs: refinance auto loan, use public transit, or carpool when possible', impact: 'Reduce to 10-15%' });
            }
            longTerm.push({ text: 'Increase income through skill development, certifications, or asking for 10-15% raise at performance review', impact: '+$' + (analytics.avgMonthlyIncome * 0.125).toFixed(0) + '/mo' });
            longTerm.push({ text: 'Start investing in low-cost index funds (after emergency fund is built) with 10-15% of income', impact: 'Long-term wealth building' });
            longTerm.push({ text: 'Max out employer 401(k) match if available (free money!), then contribute to Roth IRA', impact: 'Retirement security' });
            longTerm.push({ text: 'Set specific financial goals with timelines: down payment fund, vacation savings, etc.', impact: 'Clear direction' });
            if (shortTerm.length < 3) {
                shortTerm.push({ text: 'Track every expense for 30 days to identify spending leaks and behavioral patterns', impact: 'Awareness' });
            }
            if (shortTerm.length < 3) {
                shortTerm.push({ text: 'Set up bill payment reminders to avoid late fees and maintain good credit score', impact: 'Save $25-50/mo' });
            }
            if (mediumTerm.length < 3) {
                mediumTerm.push({ text: 'Create a sinking fund for irregular expenses (car maintenance, gifts, annual fees)', impact: 'Avoid surprises' });
            }
            document.getElementById('shortTermPlan').innerHTML = shortTerm.map(item => '<div class="plan-item"><input type="checkbox" class="plan-checkbox" /><div class="plan-text">' + item.text + '</div><div class="plan-impact">' + item.impact + '</div></div>').join('');
            document.getElementById('mediumTermPlan').innerHTML = mediumTerm.map(item => '<div class="plan-item"><input type="checkbox" class="plan-checkbox" /><div class="plan-text">' + item.text + '</div><div class="plan-impact">' + item.impact + '</div></div>').join('');
            document.getElementById('longTermPlan').innerHTML = longTerm.map(item => '<div class="plan-item"><input type="checkbox" class="plan-checkbox" /><div class="plan-text">' + item.text + '</div><div class="plan-impact">' + item.impact + '</div></div>').join('');
        }

        function createBudgetSection(analytics) {
            const budgetHtml = analytics.categoryData.map(cat => {
                const currentSpending = analytics.monthlyTrends.length > 0 ? cat.value / analytics.monthlyTrends.length : cat.value;
                const targetBudget = budgetTargets[cat.name] || Math.round(currentSpending);
                const percentage = targetBudget > 0 ? (currentSpending / targetBudget) * 100 : 0;
                let statusClass = 'good', alertBadge = '';
                if (percentage > 100) {
                    statusClass = 'danger';
                    alertBadge = '<span class="budget-alert danger">⚠️ Over Budget</span>';
                } else if (percentage > 85) {
                    statusClass = 'warning';
                    alertBadge = '<span class="budget-alert warning">⚡ Near Limit</span>';
                } else if (percentage < 70) {
                    alertBadge = '<span class="budget-alert success">✓ On Track</span>';
                }
                return '<div class="budget-item"><div class="budget-header"><strong style="color: #2d3748;">' + cat.name + alertBadge + '</strong><div><span style="color: #718096; margin-right: 10px;">Monthly Target:</span><input type="number" class="budget-input" value="' + targetBudget + '" data-category="' + cat.name + '" onchange="updateBudgetTarget(\'' + cat.name + '\', this.value)" /></div></div><div class="budget-bar"><div class="budget-fill ' + statusClass + '" style="width: ' + Math.min(percentage, 100) + '%;">$' + currentSpending.toFixed(0) + ' / $' + targetBudget + ' (' + percentage.toFixed(0) + '%)</div></div><div style="color: #718096; font-size: 0.85rem; margin-top: 5px;">' + (percentage > 100 ? '<span style="color: #ef4444;">Over by $' + (currentSpending - targetBudget).toFixed(0) + '</span>' : '<span style="color: #10b981;">Under by $' + (targetBudget - currentSpending).toFixed(0) + '</span>') + '</div></div>';
            }).join('');
            document.getElementById('budgetItems').innerHTML = budgetHtml;
            if (charts.budgetChart) charts.budgetChart.destroy();
            charts.budgetChart = new Chart(document.getElementById('budgetChart'), {
                type: 'bar',
                data: {
                    labels: analytics.categoryData.map(c => c.name),
                    datasets: [
                        { label: 'Target Budget', data: analytics.categoryData.map(c => budgetTargets[c.name] || (analytics.monthlyTrends.length > 0 ? c.value / analytics.monthlyTrends.length : c.value)), backgroundColor: '#10b981' },
                        { label: 'Actual Spending', data: analytics.categoryData.map(c => analytics.monthlyTrends.length > 0 ? c.value / analytics.monthlyTrends.length : c.value), backgroundColor: '#3b82f6' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': $' + context.parsed.y.toLocaleString(); } } } },
                    scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return '$' + value.toLocaleString(); } } } }
                }
            });
        }

        function generateTrendAnalysis(analytics) {
            try {
                const recentMonths = analytics.monthlyTrends.slice(-3);
                const previousMonths = analytics.monthlyTrends.slice(-6, -3);
                if (recentMonths.length >= 2) {
                    const recentAvg = recentMonths.reduce((sum, m) => sum + m.expenses, 0) / recentMonths.length;
                    const prevAvg = previousMonths.length > 0 ? previousMonths.reduce((sum, m) => sum + m.expenses, 0) / previousMonths.length : recentAvg;
                    const changePercent = prevAvg > 0 ? ((recentAvg - prevAvg) / prevAvg * 100) : 0;
                    const trendDir = document.getElementById('trendDirection');
                    const trendDetails = document.getElementById('trendDetails');
                    if (changePercent > 5) {
                        trendDir.textContent = '📈 Increasing';
                        trendDir.style.color = '#ef4444';
                        trendDetails.textContent = 'Up ' + changePercent.toFixed(1) + '% vs previous period';
                    } else if (changePercent < -5) {
                        trendDir.textContent = '📉 Decreasing';
                        trendDir.style.color = '#10b981';
                        trendDetails.textContent = 'Down ' + Math.abs(changePercent).toFixed(1) + '% vs previous period';
                    } else {
                        trendDir.textContent = '➡️ Stable';
                        trendDir.style.color = '#3b82f6';
                        trendDetails.textContent = '±' + Math.abs(changePercent).toFixed(1) + '% change';
                    }
                }
                if (filteredTransactionsByDate.length > 0) {
                    const totalDays = Math.ceil((new Date(filteredTransactionsByDate[filteredTransactionsByDate.length - 1].Date) - new Date(filteredTransactionsByDate[0].Date)) / (1000 * 60 * 60 * 24));
                    const dailyAvg = totalDays > 0 ? analytics.totalExpenses / totalDays : 0;
                    document.getElementById('dailyAvgSpending').textContent = '$' + dailyAvg.toFixed(2);
                    const lastMonth = analytics.monthlyTrends[analytics.monthlyTrends.length - 1];
                    if (lastMonth) {
                        const daysInLastMonth = 30;
                        const lastMonthDaily = lastMonth.expenses / daysInLastMonth;
                        const dailyChange = dailyAvg > 0 ? ((lastMonthDaily - dailyAvg) / dailyAvg * 100) : 0;
                        if (dailyChange > 5) {
                            document.getElementById('dailyTrend').textContent = '↑ ' + dailyChange.toFixed(1) + '% above average';
                            document.getElementById('dailyTrend').style.color = '#ef4444';
                        } else if (dailyChange < -5) {
                            document.getElementById('dailyTrend').textContent = '↓ ' + Math.abs(dailyChange).toFixed(1) + '% below average';
                            document.getElementById('dailyTrend').style.color = '#10b981';
                        } else {
                            document.getElementById('dailyTrend').textContent = 'On track with average';
                        }
                    }
                }
                if (analytics.monthlyTrends.length > 0) {
                    const savingsPerMonth = analytics.monthlyTrends.map(m => ({ month: m.month, savings: m.income - m.expenses }));
                    const bestSavings = savingsPerMonth.reduce((best, current) => current.savings > best.savings ? current : best);
                    document.getElementById('bestMonth').textContent = bestSavings.month;
                    document.getElementById('bestMonthAmount').textContent = 'Saved $' + bestSavings.savings.toLocaleString();
                }
                const avgExpenses = analytics.monthlyTrends.map(m => m.expenses);
                if (avgExpenses.length > 0 && analytics.avgMonthlyExpenses > 0) {
                    const variance = avgExpenses.reduce((sum, exp) => sum + Math.pow(exp - analytics.avgMonthlyExpenses, 2), 0) / avgExpenses.length;
                    const stdDev = Math.sqrt(variance);
                    const coefficientOfVariation = (stdDev / analytics.avgMonthlyExpenses) * 100;
                    if (coefficientOfVariation < 15) {
                        document.getElementById('spendingPattern').textContent = '🎯 Consistent';
                        document.getElementById('patternDetails').textContent = 'Very predictable spending';
                    } else if (coefficientOfVariation < 30) {
                        document.getElementById('spendingPattern').textContent = '📊 Moderate';
                        document.getElementById('patternDetails').textContent = 'Some variation month-to-month';
                    } else {
                        document.getElementById('spendingPattern').textContent = '🎲 Variable';
                        document.getElementById('patternDetails').textContent = 'High spending fluctuations';
                    }
                }
                const anomalies = [];
                analytics.monthlyTrends.forEach((month, idx) => {
                    if (idx === 0) return;
                    const prevMonth = analytics.monthlyTrends[idx - 1];
                    if (prevMonth.expenses > 0) {
                        const expenseChange = ((month.expenses - prevMonth.expenses) / prevMonth.expenses * 100);
                        if (expenseChange > 40) {
                            anomalies.push('<strong>' + month.month + '</strong>: Expenses spiked <strong>' + expenseChange.toFixed(0) + '%</strong> ($' + month.expenses.toLocaleString() + ' vs $' + prevMonth.expenses.toLocaleString() + ')');
                        }
                    }
                    Object.entries(month.categories).forEach(([cat, amount]) => {
                        const avgCategorySpending = analytics.categoryData.find(c => c.name === cat)?.value / analytics.monthlyTrends.length || 0;
                        if (avgCategorySpending > 0 && amount > avgCategorySpending * 2.5 && amount > 500) {
                            anomalies.push('<strong>' + month.month + '</strong>: Unusually high <strong>' + cat + '</strong> spending ($' + amount.toLocaleString() + ', ' + ((amount / avgCategorySpending - 1) * 100).toFixed(0) + '% above average)');
                        }
                    });
                });
                if (anomalies.length > 0) {
                    document.getElementById('anomalyBox').style.display = 'block';
                    document.getElementById('anomalyList').innerHTML = anomalies.slice(0, 5).map(a => '<li>' + a + '</li>').join('');
                }
                generateCategoryMomentum(analytics);
                generateSeasonalPatterns(analytics);
                generateSpendingHeatmap(analytics);
                generateForecast(analytics);
            } catch (error) {
                console.error('Error in generateTrendAnalysis:', error);
            }
        }

        function generateCategoryMomentum(analytics) {
            const recentMonths = analytics.monthlyTrends.slice(-3);
            const previousMonths = analytics.monthlyTrends.slice(-6, -3);
            if (previousMonths.length === 0 || recentMonths.length < 2) {
                document.getElementById('categoryMomentumGrid').innerHTML = '<p style="color: #718096; padding: 20px;">Need at least 6 months of data to show category momentum.</p>';
                return;
            }
            const categoryComparison = {};
            analytics.categoryData.forEach(cat => {
                const recentTotal = recentMonths.reduce((sum, m) => sum + (m.categories[cat.name] || 0), 0);
                const prevTotal = previousMonths.reduce((sum, m) => sum + (m.categories[cat.name] || 0), 0);
                const recentAvg = recentTotal / recentMonths.length;
                const prevAvg = prevTotal / previousMonths.length;
                if (prevAvg > 0) {
                    const change = ((recentAvg - prevAvg) / prevAvg * 100);
                    categoryComparison[cat.name] = { recent: recentAvg, previous: prevAvg, change: change, direction: change > 10 ? 'up' : change < -10 ? 'down' : 'stable' };
                }
            });
            const sortedCategories = Object.entries(categoryComparison).sort((a, b) => Math.abs(b[1].change) - Math.abs(a[1].change)).slice(0, 8);
            const momentumHtml = sortedCategories.map(([cat, data]) => {
                let cardClass = 'momentum-card ', indicator = '', changeColor = '';
                if (data.direction === 'up') { cardClass += 'trending-up'; indicator = '📈'; changeColor = '#ef4444'; }
                else if (data.direction === 'down') { cardClass += 'trending-down'; indicator = '📉'; changeColor = '#10b981'; }
                else { cardClass += 'stable'; indicator = '➡️'; changeColor = '#3b82f6'; }
                return '<div class="' + cardClass + '"><div class="momentum-header"><div class="momentum-title">' + cat + '</div><div class="momentum-indicator">' + indicator + '</div></div><div class="momentum-stats"><span>Last 3 mo: <strong>$' + data.recent.toFixed(0) + '</strong></span><span>Prev 3 mo: <strong>$' + data.previous.toFixed(0) + '</strong></span></div><div class="momentum-change" style="color: ' + changeColor + ';">' + (data.change > 0 ? '+' : '') + data.change.toFixed(1) + '% change</div></div>';
            }).join('');
            document.getElementById('categoryMomentumGrid').innerHTML = momentumHtml;
        }

        function generateSeasonalPatterns(analytics) {
            const seasons = {
                'Winter ❄️': { months: ['12', '01', '02'], total: 0, count: 0 },
                'Spring 🌸': { months: ['03', '04', '05'], total: 0, count: 0 },
                'Summer ☀️': { months: ['06', '07', '08'], total: 0, count: 0 },
                'Fall 🍂': { months: ['09', '10', '11'], total: 0, count: 0 }
            };
            analytics.monthlyTrends.forEach(month => {
                const monthNum = month.month.split('-')[1];
                Object.entries(seasons).forEach(([season, data]) => {
                    if (data.months.includes(monthNum)) { data.total += month.expenses; data.count++; }
                });
            });
            const seasonalHtml = Object.entries(seasons).filter(([_, data]) => data.count > 0).sort((a, b) => (b[1].total / b[1].count) - (a[1].total / a[1].count)).map(([season, data]) => {
                const avg = data.total / data.count;
                const vsOverall = analytics.avgMonthlyExpenses > 0 ? ((avg - analytics.avgMonthlyExpenses) / analytics.avgMonthlyExpenses * 100) : 0;
                return '<div class="seasonal-card"><div class="seasonal-header"><div class="seasonal-title">' + season + '</div></div><div class="seasonal-stat">Average: <strong>$' + avg.toLocaleString() + '</strong>/month</div><div class="seasonal-stat" style="color: ' + (vsOverall > 0 ? '#ef4444' : '#10b981') + ';">' + (vsOverall > 0 ? '↑' : '↓') + ' ' + Math.abs(vsOverall).toFixed(1) + '% vs overall average</div><div class="seasonal-stat" style="color: #718096;">Based on ' + data.count + ' month' + (data.count > 1 ? 's' : '') + ' of data</div></div>';
            }).join('');
            document.getElementById('seasonalInsights').innerHTML = seasonalHtml;
        }

        function generateSpendingHeatmap(analytics) {
            const dayTotals = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
            const dayCounts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
            filteredTransactionsByDate.filter(t => t.Amount < 0).forEach(t => {
                const day = new Date(t.Date).getDay();
                dayTotals[day] += Math.abs(t.Amount);
                dayCounts[day]++;
            });
            const dayAverages = Object.keys(dayTotals).map(day => ({ day: parseInt(day), avg: dayTotals[day] / (dayCounts[day] || 1) }));
            const maxAvg = Math.max(...dayAverages.map(d => d.avg));
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const heatmapHtml = '<div style="display: flex; justify-content: space-around; margin-bottom: 20px;">' + dayAverages.map(d => {
                const intensity = maxAvg > 0 ? d.avg / maxAvg : 0;
                const color = intensity > 0.8 ? '#ef4444' : intensity > 0.6 ? '#f59e0b' : intensity > 0.4 ? '#eab308' : intensity > 0.2 ? '#84cc16' : '#10b981';
                return '<div style="text-align: center; flex: 1;"><div style="font-weight: 600; color: #4a5568; margin-bottom: 8px;">' + dayNames[d.day] + '</div><div style="background: ' + color + '; height: ' + (100 + (intensity * 100)) + 'px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">$' + d.avg.toFixed(0) + '</div><div style="font-size: 0.8rem; color: #718096; margin-top: 5px;">' + dayCounts[d.day] + ' transactions</div></div>';
            }).join('') + '</div><div style="text-align: center; color: #718096; margin-top: 20px;"><strong>Insight:</strong> You spend most on <strong>' + dayNames[dayAverages.reduce((max, d) => d.avg > max.avg ? d : max).day] + '</strong></div>';
            document.getElementById('spendingHeatmap').innerHTML = heatmapHtml;
        }

        function generateForecast(analytics) {
            if (analytics.monthlyTrends.length < 3) {
                document.getElementById('forecastInsights').innerHTML = '<p style="color: #718096;">Need at least 3 months of data for forecasting</p>';
                return;
            }
            const recentMonths = analytics.monthlyTrends.slice(-6);
            const xValues = recentMonths.map((_, i) => i);
            const yValues = recentMonths.map(m => m.expenses);
            const n = xValues.length;
            const sumX = xValues.reduce((a, b) => a + b, 0);
            const sumY = yValues.reduce((a, b) => a + b, 0);
            const sumXY = xValues.reduce((sum, x, i) => sum + x * yValues[i], 0);
            const sumX2 = xValues.reduce((sum, x) => sum + x * x, 0);
            const denominator = (n * sumX2 - sumX * sumX);
            const slope = denominator !== 0 ? (n * sumXY - sumX * sumY) / denominator : 0;
            const intercept = n > 0 ? (sumY - slope * sumX) / n : 0;
            const forecasts = [];
            for (let i = 1; i <= 3; i++) {
                const predicted = intercept + slope * (n + i - 1);
                forecasts.push({ month: 'Month +' + i, amount: predicted });
            }
            const trend = slope > 50 ? 'increasing' : slope < -50 ? 'decreasing' : 'stable';
            const trendEmoji = slope > 50 ? '📈' : slope < -50 ? '📉' : '➡️';
            const forecastInsightsHtml = '<div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;"><div style="font-size: 1.1rem; font-weight: 600; color: #2d3748; margin-bottom: 10px;">' + trendEmoji + ' Your spending is trending <strong>' + trend + '</strong></div><div style="color: #4a5568;">' + (slope > 50 ? 'Expenses are increasing by approximately $' + Math.abs(slope).toFixed(0) + '/month' : slope < -50 ? 'Expenses are decreasing by approximately $' + Math.abs(slope).toFixed(0) + '/month' : 'Expenses are relatively stable month-to-month') + '</div></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">' + forecasts.map((f, i) => '<div class="forecast-card"><div class="forecast-month">' + f.month + '</div><div class="forecast-amount">$' + f.amount.toLocaleString() + '</div><div class="forecast-confidence">±10-15% variance</div></div>').join('') + '</div>';
            document.getElementById('forecastInsights').innerHTML = forecastInsightsHtml;
            if (charts.forecastChart) charts.forecastChart.destroy();
            const historicalLabels = recentMonths.map(m => m.month);
            const forecastLabels = forecasts.map(f => f.month);
            const allLabels = [...historicalLabels, ...forecastLabels];
            charts.forecastChart = new Chart(document.getElementById('forecastChart'), {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        { label: 'Historical', data: [...yValues, null, null, null], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 },
                        { label: 'Forecast', data: [...Array(n - 1).fill(null), yValues[n - 1], ...forecasts.map(f => f.amount)], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', borderDash: [5, 5], fill: true, tension: 0.4 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }

        function updateBudgetTarget(category, value) {
            budgetTargets[category] = parseFloat(value);
        }

        function saveBudget() {
            alert('✅ Budget saved! Your budget targets are active for this session.');
            processData();
        }

        function populateFilters() {
            const types = [...new Set(allTransactions.map(t => t.Type))];
            const typeFilter = document.getElementById('typeFilter');
            typeFilter.innerHTML = '<option value="all">All Types</option>';
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
        }

        function populateTransactions() {
            displayedTransactionCount = 100;
            filterTransactions();
            setupInfiniteScroll();
        }

        function setupInfiniteScroll() {
            const scrollContainer = document.getElementById('tableScrollContainer');
            scrollContainer.onscroll = function() {
                if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 50) {
                    loadMoreTransactions();
                }
            };
        }

        function loadMoreTransactions() {
            if (displayedTransactionCount >= filteredTransactionsList.length || isLoadingMore) return;
            isLoadingMore = true;
            document.getElementById('loadingMore').style.display = 'block';
            setTimeout(() => {
                displayedTransactionCount += 100;
                renderTransactions();
                document.getElementById('loadingMore').style.display = 'none';
                isLoadingMore = false;
            }, 300);
        }

        function filterTransactions() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const days = parseInt(document.getElementById('dateFilter').value);
            let filtered = [...filteredTransactionsByDate].reverse();
            if (search) filtered = filtered.filter(t => t.Description.toLowerCase().includes(search));
            if (type !== 'all') filtered = filtered.filter(t => t.Type === type);
            if (category !== 'all') filtered = filtered.filter(t => t.Category === category);
            if (days !== 'all' && !isNaN(days)) {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                filtered = filtered.filter(t => new Date(t.Date) >= cutoff);
            }
            filteredTransactionsList = filtered;
            displayedTransactionCount = 100;
            const scrollContainer = document.getElementById('tableScrollContainer');
            if (scrollContainer) scrollContainer.scrollTop = 0;
            renderTransactions();
        }

        function renderTransactions() {
            const toDisplay = filteredTransactionsList.slice(0, displayedTransactionCount);
            const tbody = document.getElementById('transactionsBody');
            
            try {
                tbody.innerHTML = toDisplay.map(t => {
                    const amount = parseFloat(t.Amount) || 0;
                    const balance = parseFloat(t['Current balance']) || 0;
                    const date = t.Date ? new Date(t.Date).toLocaleDateString() : 'N/A';
                    const description = t.Description || 'No description';
                    const type = t.Type || 'N/A';
                    const category = t.Category || 'Unmarked';
                    
                    return '<tr class="transaction-row ' + (selectedTransactions.has(t._id) ? 'selected' : '') + '" data-id="' + t._id + '"><td><input type="checkbox" class="select-checkbox" ' + (selectedTransactions.has(t._id) ? 'checked' : '') + ' onchange="toggleTransactionSelect(' + t._id + ')" /></td><td>' + date + '</td><td>' + description + '</td><td>' + type + '</td><td><span class="category-tag category-' + category.replace(/[^a-zA-Z]/g, '') + '" onclick="openCategoryModal(' + t._id + ')">' + category + '</span></td><td style="text-align: right;" class="' + (amount > 0 ? 'positive' : 'negative') + '">' + (amount > 0 ? '+' : '') + Math.abs(amount).toFixed(2) + '</td><td style="text-align: right;">' + balance.toFixed(2) + '</td></tr>';
                }).join('');
                
                const totalIncome = filteredTransactionsList.reduce((sum, t) => sum + ((parseFloat(t.Amount) || 0) > 0 ? (parseFloat(t.Amount) || 0) : 0), 0);
                const totalExpenses = filteredTransactionsList.reduce((sum, t) => sum + ((parseFloat(t.Amount) || 0) < 0 ? Math.abs(parseFloat(t.Amount) || 0) : 0), 0);
                const netAmount = totalIncome - totalExpenses;
                
                const totalAmountEl = document.getElementById('totalAmount');
                const totalBreakdownEl = document.getElementById('totalBreakdown');
                totalAmountEl.innerHTML = '<span style="color: ' + (netAmount >= 0 ? '#10b981' : '#ef4444') + ';">' + (netAmount >= 0 ? '+' : '') + ' + netAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</span>';
                totalBreakdownEl.innerHTML = '<span style="color: #10b981;">Income: + + totalIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</span> | <span style="color: #ef4444;">Expenses: - + totalExpenses.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</span>';
                
                const countText = filteredTransactionsList.length > displayedTransactionCount ? 'Showing ' + displayedTransactionCount + ' of ' + filteredTransactionsList.length + ' transactions (scroll for more)' : filteredTransactionsList.length + ' transactions';
                document.getElementById('transactionCount').textContent = countText;
            } catch (error) {
                console.error('Error rendering transactions:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">Error displaying transactions. Please refresh and try again.</td></tr>';
            }
        }

        function toggleTransactionSelect(transactionId) {
            if (selectedTransactions.has(transactionId)) {
                selectedTransactions.delete(transactionId);
            } else {
                selectedTransactions.add(transactionId);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const visibleTransactions = filteredTransactionsList.slice(0, displayedTransactionCount);
            if (selectAll) {
                visibleTransactions.forEach(t => selectedTransactions.add(t._id));
            } else {
                visibleTransactions.forEach(t => selectedTransactions.delete(t._id));
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            const exportBtn = document.getElementById('exportBtn');
            
            if (selectedTransactions.size > 0) {
                bulkActions.classList.add('active');
                selectedCount.textContent = selectedTransactions.size + ' selected';
                exportBtn.textContent = '📥 Export Selected (' + selectedTransactions.size + ')';
            } else {
                bulkActions.classList.remove('active');
                exportBtn.textContent = '📥 Export All';
            }
            renderTransactions();
        }

        function clearSelection() {
            selectedTransactions.clear();
            document.getElementById('selectAll').checked = false;
            updateSelectionUI();
        }

        function bulkRecategorize() {
            if (selectedTransactions.size === 0) return;
            document.getElementById('modalDescription').textContent = 'Recategorize ' + selectedTransactions.size + ' selected transactions';
            const optionsHtml = categories.map(cat => '<div class="category-option" onclick="selectCategory(\'' + cat + '\')">' + cat + '</div>').join('');
            document.getElementById('categoryOptions').innerHTML = optionsHtml;
            document.getElementById('categoryModal').classList.add('active');
            currentEditTransaction = { isBulk: true };
        }

        function openCategoryModal(transactionId) {
            currentEditTransaction = allTransactions.find(t => t._id === transactionId);
            if (!currentEditTransaction) return;
            document.getElementById('modalDescription').textContent = currentEditTransaction.Description + ' (Current: ' + currentEditTransaction.Category + ')';
            const optionsHtml = categories.map(cat => '<div class="category-option" onclick="selectCategory(\'' + cat + '\')">' + cat + '</div>').join('');
            document.getElementById('categoryOptions').innerHTML = optionsHtml;
            document.getElementById('categoryModal').classList.add('active');
        }

        function selectCategory(category) {
            document.querySelectorAll('.category-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            if (currentEditTransaction) {
                currentEditTransaction.tempCategory = category;
            }
        }

        function saveCategory() {
            if (!currentEditTransaction || !currentEditTransaction.tempCategory) {
                alert('Please select a category first!');
                return;
            }
            if (currentEditTransaction.isBulk) {
                selectedTransactions.forEach(id => {
                    const transaction = allTransactions.find(t => t._id === id);
                    if (transaction) {
                        transaction.CustomCategory = currentEditTransaction.tempCategory;
                        transaction.Category = currentEditTransaction.tempCategory;
                    }
                });
                clearSelection();
            } else {
                currentEditTransaction.CustomCategory = currentEditTransaction.tempCategory;
                currentEditTransaction.Category = currentEditTransaction.tempCategory;
            }
            closeModal();
            processData();
        }

        function closeModal() {
            document.getElementById('categoryModal').classList.remove('active');
            currentEditTransaction = null;
        }

        function exportCSV() {
            let transactionsToExport;
            let filename;
            
            if (selectedTransactions.size > 0) {
                transactionsToExport = allTransactions.filter(t => selectedTransactions.has(t._id));
                filename = 'financial_data_selected_' + selectedTransactions.size + '_transactions.csv';
            } else {
                transactionsToExport = allTransactions;
                filename = 'financial_data_tagged.csv';
            }
            
            const headers = ['Date', 'Description', 'Type', 'Amount', 'Current balance', 'Status', 'CustomCategory'];
            const csvContent = [headers.join(','), ...transactionsToExport.map(t => [t.Date, '"' + t.Description + '"', t.Type, t.Amount, t['Current balance'], t.Status, t.CustomCategory || ''].join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            
            if (selectedTransactions.size > 0) {
                alert('✅ Exported ' + selectedTransactions.size + ' selected transactions with custom categories!');
            } else {
                alert('✅ CSV exported with your custom categories!');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            const activeTab = Array.from(document.querySelectorAll('.tab')).find(t => t.getAttribute('onclick').includes(tabName));
            if (activeTab) activeTab.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }
    </script>
</body>
</html>
