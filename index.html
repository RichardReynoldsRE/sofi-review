<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-section {
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }
        
        .upload-section h1 {
            font-size: 2.5rem;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .upload-section p {
            color: #718096;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .dashboard {
            display: none;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2rem;
        }
        
        .header p {
            color: #718096;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f7fafc;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #4a5568;
        }
        
        .tab:hover {
            background: #edf2f7;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-sub {
            color: #a0aec0;
            font-size: 0.85rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .chart-container h3 {
            color: #2d3748;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .action-plan {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .plan-section {
            margin-bottom: 30px;
        }
        
        .plan-section h4 {
            color: #2d3748;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .plan-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: start;
            gap: 10px;
        }
        
        .plan-checkbox {
            margin-top: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .plan-text {
            flex: 1;
            color: #4a5568;
            line-height: 1.6;
        }
        
        .plan-impact {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .budget-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .budget-item {
            margin-bottom: 20px;
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .budget-input {
            width: 120px;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .budget-bar {
            height: 30px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .budget-fill {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: width 0.5s ease;
        }
        
        .budget-fill.good {
            background: #10b981;
            color: white;
        }
        
        .budget-fill.warning {
            background: #f59e0b;
            color: white;
        }
        
        .budget-fill.danger {
            background: #ef4444;
            color: white;
        }
        
        .transactions-table {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .table-scroll-container {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.85rem;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
            color: #2d3748;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .positive {
            color: #48bb78;
            font-weight: 600;
        }
        
        .negative {
            color: #f56565;
            font-weight: 600;
        }
        
        .category-tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-tag:hover {
            transform: scale(1.05);
        }
        
        .transaction-row.selected {
            background: #e0e7ff !important;
        }
        
        .select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .bulk-actions {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .bulk-actions.active {
            display: flex;
        }
        
        .bulk-actions button {
            padding: 8px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .bulk-actions button:hover {
            background: #f0f4ff;
        }
        
        .category-Miscellaneous { background: #e2e8f0; color: #4a5568; }
        .category-Housing { background: #dbeafe; color: #1e3a8a; }
        .category-Utilities { background: #ede9fe; color: #5b21b6; }
        .category-Groceries { background: #d1fae5; color: #065f46; }
        .category-Transportation { background: #ccfbf1; color: #134e4a; }
        .category-Healthcare { background: #fef3c7; color: #78350f; }
        .category-Insurance { background: #fce7f3; color: #831843; }
        .category-DebtPayments { background: #fee2e2; color: #7f1d1d; }
        .category-SavingsInvestments { background: #d1fae5; color: #14532d; }
        .category-PersonalCare { background: #f3e8ff; color: #581c87; }
        .category-DiningOut { background: #fed7aa; color: #7c2d12; }
        .category-Entertainment { background: #cffafe; color: #164e63; }
        .category-BusinessExpense { background: #dbeafe; color: #075985; }
        .category-Gifts { background: #fce7f3; color: #9f1239; }
        .category-Income { background: #d1fae5; color: #166534; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-content h3 {
            color: #2d3748;
            margin-bottom: 20px;
        }
        
        .category-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .category-option {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .category-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .category-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }
        
        .insight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .insight-box h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .insight-box ul {
            list-style: none;
            padding: 0;
        }
        
        .insight-box li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .insight-box li:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <h1>üí∞ Advanced Financial Dashboard</h1>
            <p>Upload your bank transaction CSV to unlock powerful insights with research-backed budget categories</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".csv" />
                <label for="fileInput" class="file-input-label">
                    üìä Choose CSV File
                </label>
            </div>
            <div class="loading" id="loadingText" style="display: none;">
                Analyzing your financial data...
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="header">
                <div class="header-top">
                    <div>
                        <h1>Your Financial Command Center</h1>
                        <p id="dateRange"></p>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="exportCSV()">üì• Export Tagged Data</button>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
                    <button class="tab" onclick="switchTab('insights')">üí° Insights</button>
                    <button class="tab" onclick="switchTab('action')">üéØ Action Plan</button>
                    <button class="tab" onclick="switchTab('budget')">üíµ Budget</button>
                    <button class="tab" onclick="switchTab('trends')">üìà Trends</button>
                    <button class="tab" onclick="switchTab('transactions')">üìã Transactions</button>
                </div>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Current Balance</div>
                        <div class="stat-value" id="currentBalance" style="color: #4299e1;">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Income</div>
                        <div class="stat-value positive" id="totalIncome">$0</div>
                        <div class="stat-sub" id="avgIncome"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Expenses</div>
                        <div class="stat-value negative" id="totalExpenses">$0</div>
                        <div class="stat-sub" id="avgExpenses"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Savings Rate</div>
                        <div class="stat-value" id="savingsRate" style="color: #9f7aea;">0%</div>
                        <div class="stat-sub" id="netSavings"></div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Spending by Category</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Monthly Trend</h3>
                        <canvas id="miniTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="insightsTab" class="tab-content" style="display: none;">
                <div class="insight-box">
                    <h3>üéØ Key Financial Insights</h3>
                    <ul id="insightsList"></ul>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Spending Breakdown</h3>
                        <canvas id="detailedCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Category Details</h3>
                        <div id="categoryDetailsList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Action Plan Tab -->
            <div id="actionTab" class="tab-content" style="display: none;">
                <div class="action-plan">
                    <h3 style="color: #2d3748; font-size: 1.8rem; margin-bottom: 30px;">üìã Your Personalized Action Plan</h3>
                    
                    <div class="plan-section">
                        <h4>üöÄ Short-term (Next 30 Days)</h4>
                        <div id="shortTermPlan"></div>
                    </div>

                    <div class="plan-section">
                        <h4>üìÖ Medium-term (Next 3 Months)</h4>
                        <div id="mediumTermPlan"></div>
                    </div>

                    <div class="plan-section">
                        <h4>üéØ Long-term (Next Year)</h4>
                        <div id="longTermPlan"></div>
                    </div>
                </div>
            </div>

            <!-- Budget Tab -->
            <div id="budgetTab" class="tab-content" style="display: none;">
                <div class="budget-section">
                    <h3 style="margin-bottom: 30px;">üíµ Monthly Budget Planner</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Set your target budget for each category and track your progress</p>
                    <div id="budgetItems"></div>
                    <button class="btn btn-primary" onclick="saveBudget()" style="margin-top: 20px;">üíæ Save Budget</button>
                </div>

                <div class="chart-container">
                    <h3>Budget vs Actual Spending</h3>
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trendsTab" class="tab-content" style="display: none;">
                <div class="chart-container">
                    <h3>Monthly Income vs Expenses</h3>
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Balance Over Time</h3>
                    <canvas id="balanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Category Trends Over Time</h3>
                    <canvas id="categoryTrendChart"></canvas>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactionsTab" class="tab-content" style="display: none;">
                <div class="transactions-table">
                    <h3>Transaction History & Tagging</h3>
                    <p style="color: #718096; margin-bottom: 20px;">Click on category tags to recategorize transactions using our 15 universal budget categories, or select multiple rows for bulk tagging</p>
                    
                    <div class="bulk-actions" id="bulkActions">
                        <span id="selectedCount">0 selected</span>
                        <button onclick="bulkRecategorize()">üè∑Ô∏è Recategorize Selected</button>
                        <button onclick="clearSelection()">‚úï Clear Selection</button>
                    </div>
                    
                    <div class="filters">
                        <input type="text" class="filter-input" id="searchInput" placeholder="üîç Search transactions..." />
                        <select class="filter-input" id="typeFilter">
                            <option value="all">All Types</option>
                        </select>
                        <select class="filter-input" id="categoryFilter">
                            <option value="all">All Categories</option>
                        </select>
                        <select class="filter-input" id="dateFilter">
                            <option value="all">All Time</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    <div class="table-scroll-container" id="tableScrollContainer">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" class="select-checkbox" id="selectAll" onchange="toggleSelectAll()" />
                                    </th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th style="text-align: right;">Amount</th>
                                    <th style="text-align: right;">Balance</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsBody"></tbody>
                        </table>
                    </div>
                    <p id="transactionCount" style="margin-top: 15px; color: #718096; text-align: center;"></p>
                    <div id="loadingMore" style="text-align: center; padding: 20px; color: #718096; display: none;">
                        Loading more transactions...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <h3>Recategorize Transaction</h3>
            <p id="modalDescription" style="color: #718096; margin-bottom: 20px;"></p>
            <div class="category-options" id="categoryOptions"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveCategory()">Save</button>
                <button class="btn" style="background: #e2e8f0;" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let allTransactions = [];
        let charts = {};
        let categoryCustomizations = {};
        let currentEditTransaction = null;
        let budgetTargets = {};
        let selectedTransactions = new Set();
        let displayedTransactionCount = 100;
        let filteredTransactionsList = [];
        let isLoadingMore = false;

        const categories = ['Housing', 'Utilities', 'Groceries', 'Transportation', 'Healthcare', 'Insurance', 'Debt Payments', 'Savings & Investments', 'Personal Care', 'Dining Out', 'Entertainment', 'Business Expense', 'Gifts', 'Income', 'Miscellaneous'];
        const categoryColors = {
            'Housing': '#3b82f6',
            'Utilities': '#8b5cf6',
            'Groceries': '#10b981',
            'Transportation': '#14b8a6',
            'Healthcare': '#f59e0b',
            'Insurance': '#ec4899',
            'Debt Payments': '#ef4444',
            'Savings & Investments': '#10b981',
            'Personal Care': '#a855f7',
            'Dining Out': '#f97316',
            'Entertainment': '#06b6d4',
            'Business Expense': '#0ea5e9',
            'Gifts': '#f472b6',
            'Income': '#22c55e',
            'Miscellaneous': '#6b7280'
        };

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('searchInput').addEventListener('input', filterTransactions);
        document.getElementById('typeFilter').addEventListener('change', filterTransactions);
        document.getElementById('categoryFilter').addEventListener('change', filterTransactions);
        document.getElementById('dateFilter').addEventListener('change', filterTransactions);

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loadingText').style.display = 'block';

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    allTransactions = results.data.map((row, idx) => {
                        const cleaned = {};
                        Object.keys(row).forEach(key => {
                            cleaned[key.trim()] = row[key];
                        });
                        cleaned._id = idx;
                        cleaned.CustomCategory = cleaned.CustomCategory || null;
                        return cleaned;
                    });

                    processData();
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                }
            });
        }

        function categorizeTransaction(transaction) {
            if (transaction.CustomCategory) return transaction.CustomCategory;
            
            const desc = transaction.Description.toUpperCase();
            const amount = transaction.Amount;
            
            // Income - positive amounts (deposits, paychecks, refunds, etc.)
            if (amount > 0) {
                if (desc.includes('DEPOSIT') || desc.includes('PAYROLL') || desc.includes('DIRECT DEPOSIT') ||
                    desc.includes('SALARY') || desc.includes('PAYCHECK') || desc.includes('PAYMENT FROM') ||
                    desc.includes('ACH CREDIT') || desc.includes('REFUND') || desc.includes('REIMBURSEMENT') ||
                    desc.includes('INTEREST EARNED') || desc.includes('DIVIDEND') || desc.includes('BONUS')) {
                    return 'Income';
                }
            }
            
            // Business Expense - work-related costs
            if (desc.includes('BUSINESS') || desc.includes('OFFICE SUPPLY') || desc.includes('STAPLES') ||
                desc.includes('OFFICE DEPOT') || desc.includes('FEDEX OFFICE') || desc.includes('UPS STORE') ||
                desc.includes('LINKEDIN') || desc.includes('QUICKBOOKS') || desc.includes('ADOBE') ||
                desc.includes('MICROSOFT 365') || desc.includes('ZOOM') || desc.includes('SLACK') ||
                desc.includes('DROPBOX') || desc.includes('DOMAIN') || desc.includes('HOSTING') ||
                desc.includes('AWS') || desc.includes('GOOGLE WORKSPACE') || desc.includes('PROFESSIONAL')) {
                return 'Business Expense';
            }
            
            // Gifts - giving and gift purchases
            if (desc.includes('GIFT') || desc.includes('FLOWERS') || desc.includes('FTDS') ||
                desc.includes('1-800-FLOWERS') || desc.includes('EDIBLE ARRANGEMENTS') ||
                desc.includes('HALLMARK') || desc.includes('CARD STORE') || desc.includes('TOY STORE') ||
                desc.includes('TOYS R US') || desc.includes('BUILD-A-BEAR') || desc.includes('CHARITABLE') ||
                desc.includes('DONATION') || desc.includes('CHARITY') || desc.includes('GIVING')) {
                return 'Gifts';
            }
            
            // Housing - Rent, mortgage, property tax, HOA
            if (desc.includes('RENT') || desc.includes('MORTGAGE') || desc.includes('PROPERTY TAX') || 
                desc.includes('HOA') || desc.includes('LANDLORD') || desc.includes('APARTMENT') ||
                desc.includes('U-HAUL') || desc.includes('STORAGE')) {
                return 'Housing';
            }
            
            // Utilities - Electric, water, gas, internet, phone
            if (desc.includes('ELECTRIC') || desc.includes('POWER') || desc.includes('UTILITY') || 
                desc.includes('WATER') || desc.includes('GAS COMPANY') || desc.includes('INTERNET') || 
                desc.includes('COMCAST') || desc.includes('VERIZON') || desc.includes('ATT') || 
                desc.includes('T-MOBILE') || desc.includes('SPRINT') || desc.includes('SPECTRUM') ||
                desc.includes('INMOTION') || desc.includes('PHONE') || desc.includes('CABLE') ||
                desc.includes('XFINITY') || desc.includes('COX') || desc.includes('FRONTIER')) {
                return 'Utilities';
            }
            
            // Groceries - Supermarkets and grocery stores
            if (desc.includes('HANNAFORD') || desc.includes('SHAWS') || desc.includes('WALMART') || 
                desc.includes('TARGET') || desc.includes('COSTCO') || desc.includes('SAMS CLUB') ||
                desc.includes('WHOLE FOODS') || desc.includes('TRADER JOE') || desc.includes('ALDI') ||
                desc.includes('KROGER') || desc.includes('PUBLIX') || desc.includes('SAFEWAY') ||
                desc.includes('GROCERY') || desc.includes('SUPERMARKET') || desc.includes('FOOD LION') ||
                desc.includes('WEGMANS') || desc.includes('STOP & SHOP')) {
                return 'Groceries';
            }
            
            // Dining Out - Restaurants, fast food, coffee shops, delivery
            if (desc.includes('RESTAURANT') || desc.includes('PIZZA') || desc.includes('CAFE') || 
                desc.includes('COFFEE') || desc.includes('DUNKIN') || desc.includes('STARBUCKS') ||
                desc.includes('MCDONALDS') || desc.includes('BURGER') || desc.includes('TACO') ||
                desc.includes('SUBWAY') || desc.includes('CHIPOTLE') || desc.includes('PANERA') ||
                desc.includes('BAGEL') || desc.includes('DOORDASH') || desc.includes('UBER EATS') ||
                desc.includes('GRUBHUB') || desc.includes('DELIVERY') || desc.includes('DINE') ||
                desc.includes('WENDYS') || desc.includes('CHICK-FIL-A') || desc.includes('DOMINOS')) {
                return 'Dining Out';
            }
            
            // Transportation - Gas, car payment, insurance, maintenance, public transit
            if (desc.includes('GAS') || desc.includes('FUEL') || desc.includes('SHELL') || 
                desc.includes('EXXON') || desc.includes('MOBIL') || desc.includes('CHEVRON') ||
                desc.includes('BP ') || desc.includes('SUNOCO') || desc.includes('AUTO PAYMENT') ||
                desc.includes('CAR PAYMENT') || desc.includes('UBER') || desc.includes('LYFT') ||
                desc.includes('TRANSIT') || desc.includes('PARKING') || desc.includes('TOLL') ||
                desc.includes('AAA ') || desc.includes('JIFFY LUBE') || desc.includes('MIDAS') ||
                desc.includes('AUTO REPAIR') || desc.includes('MECHANIC') || desc.includes('DMV') ||
                desc.includes('VALVOLINE') || desc.includes('PEP BOYS')) {
                return 'Transportation';
            }
            
            // Healthcare - Medical, dental, vision, pharmacy, doctor visits
            if (desc.includes('HOSPITAL') || desc.includes('MEDICAL') || desc.includes('DOCTOR') || 
                desc.includes('DENTAL') || desc.includes('DENTIST') || desc.includes('VISION') ||
                desc.includes('PHARMACY') || desc.includes('CVS') || desc.includes('WALGREENS') ||
                desc.includes('RITE AID') || desc.includes('PRESCRIPTION') || desc.includes('CLINIC') ||
                desc.includes('HEALTH') || desc.includes('URGENT CARE') || desc.includes('THERAPY') ||
                desc.includes('CHIROPRACTOR') || desc.includes('PHYSICAL THERAPY')) {
                return 'Healthcare';
            }
            
            // Insurance - Life, health, home, auto insurance (if not already categorized)
            if (desc.includes('INSURANCE') || desc.includes('GEICO') || desc.includes('STATE FARM') ||
                desc.includes('PROGRESSIVE') || desc.includes('ALLSTATE') || desc.includes('USAA') ||
                desc.includes('LIBERTY MUTUAL') || desc.includes('PREMIUM') || desc.includes('FARMERS INS')) {
                return 'Insurance';
            }
            
            // Debt Payments - Credit cards, loans, student loans
            if (desc.includes('CREDIT CARD PAYMENT') || desc.includes('LOAN PAYMENT') || 
                desc.includes('STUDENT LOAN') || desc.includes('NELNET') || desc.includes('NAVIENT') ||
                desc.includes('GREAT LAKES') || desc.includes('PAYMENT TO CHASE') || 
                desc.includes('PAYMENT TO CITI') || desc.includes('PAYMENT TO DISCOVER') ||
                desc.includes('PAYMENT TO CAPITAL ONE') || desc.includes('PAYMENT TO AMEX')) {
                return 'Debt Payments';
            }
            
            // Savings & Investments - Transfers to savings, investment accounts, retirement
            if (desc.includes('SAVINGS') || desc.includes('INVESTMENT') || desc.includes('401K') ||
                desc.includes('IRA') || desc.includes('FIDELITY') || desc.includes('VANGUARD') ||
                desc.includes('SCHWAB') || desc.includes('ROBINHOOD') || desc.includes('BETTERMENT') ||
                desc.includes('WEALTHFRONT') || desc.includes('E*TRADE') || desc.includes('TD AMERITRADE') ||
                (amount < 0 && desc.includes('TRANSFER TO SAVINGS'))) {
                return 'Savings & Investments';
            }
            
            // Personal Care - Haircuts, gym, clothing, personal hygiene
            if (desc.includes('SALON') || desc.includes('BARBER') || desc.includes('HAIRCUT') || 
                desc.includes('SPA') || desc.includes('GYM') || desc.includes('FITNESS') ||
                desc.includes('PLANET FITNESS') || desc.includes('LA FITNESS') || desc.includes('YMCA') ||
                desc.includes('CLOTHING') || desc.includes('APPAREL') || desc.includes('FOOTWEAR') ||
                desc.includes('NIKE') || desc.includes('ADIDAS') || desc.includes('KOHLS') ||
                desc.includes('MACYS') || desc.includes('NORDSTROM') || desc.includes('SEPHORA') ||
                desc.includes('ULTA') || desc.includes('OLD NAVY') || desc.includes('GAP')) {
                return 'Personal Care';
            }
            
            // Entertainment - Streaming, movies, hobbies, subscriptions, recreation
            if (desc.includes('NETFLIX') || desc.includes('HULU') || desc.includes('DISNEY') ||
                desc.includes('SPOTIFY') || desc.includes('APPLE MUSIC') || desc.includes('HBO') ||
                desc.includes('AMAZON PRIME') || desc.includes('MOVIE') || desc.includes('THEATER') ||
                desc.includes('CINEMA') || desc.includes('CONCERT') || desc.includes('TICKET') ||
                desc.includes('STEAM') || desc.includes('PLAYSTATION') || desc.includes('XBOX') ||
                desc.includes('NINTENDO') || desc.includes('HOBBY') || desc.includes('BEST BUY') ||
                desc.includes('GAMESTOP') || desc.includes('AMC THEATERS') || desc.includes('REGAL')) {
                return 'Entertainment';
            }
            
            // Special handling for common merchant patterns
            if (desc.includes('AMAZON') || desc.includes('AMZN')) {
                // Amazon could be groceries, shopping, or entertainment - default to Miscellaneous for user to categorize
                return 'Miscellaneous';
            }
            
            if (desc.includes('VENMO') || desc.includes('PAYPAL') || desc.includes('ZELLE') || 
                desc.includes('CASH APP') || desc.includes('CHECK')) {
                // Transfers and payments - could be anything, let user categorize
                return 'Miscellaneous';
            }
            
            if (desc.includes('USPS') || desc.includes('FEDEX') || desc.includes('UPS')) {
                return 'Miscellaneous';
            }
            
            // Default to Miscellaneous for anything not categorized
            return 'Miscellaneous';
        }

        function processData() {
            const analytics = calculateAnalytics();
            updateStats(analytics);
            createCharts(analytics);
            generateInsights(analytics);
            generateActionPlan(analytics);
            createBudgetSection(analytics);
            populateTransactions();
            populateFilters();
        }

        function calculateAnalytics() {
            allTransactions.forEach(t => {
                t.Category = categorizeTransaction(t);
            });

            const totalIncome = allTransactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            const totalExpenses = Math.abs(allTransactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const currentBalance = allTransactions[allTransactions.length - 1]?.['Current balance'] || 0;

            const monthlyData = {};
            allTransactions.forEach(t => {
                const date = new Date(t.Date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = { 
                        month: key, 
                        income: 0, 
                        expenses: 0, 
                        balance: 0,
                        categories: {}
                    };
                }
                
                if (t.Amount > 0) {
                    monthlyData[key].income += t.Amount;
                } else {
                    monthlyData[key].expenses += Math.abs(t.Amount);
                    const cat = t.Category;
                    if (!monthlyData[key].categories[cat]) monthlyData[key].categories[cat] = 0;
                    monthlyData[key].categories[cat] += Math.abs(t.Amount);
                }
                monthlyData[key].balance = t['Current balance'];
            });

            const monthlyTrends = Object.values(monthlyData).sort((a, b) => a.month.localeCompare(b.month));

            const categoryData = {};
            const categoryDetails = {};
            allTransactions.filter(t => t.Amount < 0).forEach(t => {
                const cat = t.Category;
                if (!categoryData[cat]) {
                    categoryData[cat] = 0;
                    categoryDetails[cat] = [];
                }
                categoryData[cat] += Math.abs(t.Amount);
                categoryDetails[cat].push({
                    description: t.Description,
                    amount: Math.abs(t.Amount),
                    date: t.Date
                });
            });

            const categoryArray = Object.entries(categoryData)
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value);

            return {
                totalIncome,
                totalExpenses,
                currentBalance,
                monthlyTrends,
                categoryData: categoryArray,
                categoryDetails,
                avgMonthlyIncome: totalIncome / monthlyTrends.length,
                avgMonthlyExpenses: totalExpenses / monthlyTrends.length
            };
        }

        function updateStats(analytics) {
            const firstDate = new Date(allTransactions[0].Date).toLocaleDateString();
            const lastDate = new Date(allTransactions[allTransactions.length - 1].Date).toLocaleDateString();
            document.getElementById('dateRange').textContent = `${firstDate} - ${lastDate}`;

            document.getElementById('currentBalance').textContent = `$${analytics.currentBalance.toLocaleString()}`;
            document.getElementById('totalIncome').textContent = `$${analytics.totalIncome.toLocaleString()}`;
            document.getElementById('avgIncome').textContent = `Avg: $${Math.round(analytics.avgMonthlyIncome).toLocaleString()}/mo`;
            document.getElementById('totalExpenses').textContent = `$${analytics.totalExpenses.toLocaleString()}`;
            document.getElementById('avgExpenses').textContent = `Avg: $${Math.round(analytics.avgMonthlyExpenses).toLocaleString()}/mo`;
            
            const savingsRate = ((analytics.totalIncome - analytics.totalExpenses) / analytics.totalIncome * 100).toFixed(1);
            document.getElementById('savingsRate').textContent = `${savingsRate}%`;
            document.getElementById('netSavings').textContent = `Net: $${Math.round(analytics.totalIncome - analytics.totalExpenses).toLocaleString()}`;
        }

        function createCharts(analytics) {
            const colors = Object.values(categoryColors);

            if (charts.categoryChart) charts.categoryChart.destroy();
            charts.categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: analytics.categoryData.map(c => c.name),
                    datasets: [{
                        data: analytics.categoryData.map(c => c.value),
                        backgroundColor: analytics.categoryData.map(c => categoryColors[c.name] || '#6b7280')
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            if (charts.miniTrendChart) charts.miniTrendChart.destroy();
            charts.miniTrendChart = new Chart(document.getElementById('miniTrendChart'), {
                type: 'line',
                data: {
                    labels: analytics.monthlyTrends.slice(-6).map(m => m.month),
                    datasets: [{
                        label: 'Balance',
                        data: analytics.monthlyTrends.slice(-6).map(m => m.balance),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            if (charts.detailedCategoryChart) charts.detailedCategoryChart.destroy();
            charts.detailedCategoryChart = new Chart(document.getElementById('detailedCategoryChart'), {
                type: 'bar',
                data: {
                    labels: analytics.categoryData.map(c => c.name),
                    datasets: [{
                        label: 'Spending',
                        data: analytics.categoryData.map(c => c.value),
                        backgroundColor: analytics.categoryData.map(c => categoryColors[c.name] || '#6b7280')
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            const detailsHtml = analytics.categoryData.map(cat => {
                const details = analytics.categoryDetails[cat.name] || [];
                const avgTransaction = cat.value / details.length;
                return `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong style="color: #2d3748;">${cat.name}</strong>
                            <strong style="color: ${categoryColors[cat.name]};">$${cat.value.toLocaleString()}</strong>
                        </div>
                        <div style="color: #718096; font-size: 0.9rem;">
                            ${details.length} transactions | Avg: $${avgTransaction.toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('categoryDetailsList').innerHTML = detailsHtml;

            if (charts.monthlyChart) charts.monthlyChart.destroy();
            charts.monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                type: 'line',
                data: {
                    labels: analytics.monthlyTrends.map(m => m.month),
                    datasets: [
                        {
                            label: 'Income',
                            data: analytics.monthlyTrends.map(m => m.income),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Expenses',
                            data: analytics.monthlyTrends.map(m => m.expenses),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            if (charts.balanceChart) charts.balanceChart.destroy();
            charts.balanceChart = new Chart(document.getElementById('balanceChart'), {
                type: 'line',
                data: {
                    labels: analytics.monthlyTrends.map(m => m.month),
                    datasets: [{
                        label: 'Balance',
                        data: analytics.monthlyTrends.map(m => m.balance),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            const categoryTrendData = {};
            analytics.monthlyTrends.forEach(month => {
                Object.entries(month.categories).forEach(([cat, value]) => {
                    if (!categoryTrendData[cat]) categoryTrendData[cat] = [];
                    categoryTrendData[cat].push(value);
                });
            });

            if (charts.categoryTrendChart) charts.categoryTrendChart.destroy();
            charts.categoryTrendChart = new Chart(document.getElementById('categoryTrendChart'), {
                type: 'line',
                data: {
                    labels: analytics.monthlyTrends.map(m => m.month),
                    datasets: Object.entries(categoryTrendData).map(([cat, data]) => ({
                        label: cat,
                        data: data,
                        borderColor: categoryColors[cat] || '#6b7280',
                        tension: 0.4
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        function generateInsights(analytics) {
            const insights = [];
            const savingsRate = ((analytics.totalIncome - analytics.totalExpenses) / analytics.totalIncome * 100);

            if (savingsRate < 10) {
                insights.push(`Your current savings rate is ${savingsRate.toFixed(1)}%. Financial experts recommend 15-20% for healthy financial growth.`);
            } else if (savingsRate >= 20) {
                insights.push(`Excellent! Your ${savingsRate.toFixed(1)}% savings rate exceeds the recommended 15-20%. Keep up the great work!`);
            } else {
                insights.push(`Good progress! Your ${savingsRate.toFixed(1)}% savings rate is on track. Push toward 20% for optimal financial health.`);
            }

            const topCategory = analytics.categoryData[0];
            const topPercent = (topCategory.value / analytics.totalExpenses * 100).toFixed(1);
            insights.push(`Your highest spending category is "${topCategory.name}" at ${topCategory.value.toLocaleString()} (${topPercent}% of expenses).`);
            
            // Housing insights (should be 25-35% of income)
            const housingCategory = analytics.categoryData.find(c => c.name === 'Housing');
            if (housingCategory) {
                const housingPercent = (housingCategory.value / (analytics.totalIncome / analytics.monthlyTrends.length) * analytics.monthlyTrends.length * 100);
                if (housingPercent > 35) {
                    insights.push(`‚ö†Ô∏è Your housing costs are ${housingPercent.toFixed(0)}% of income. Experts recommend keeping housing under 30-35%.`);
                } else if (housingPercent < 25) {
                    insights.push(`‚úÖ Great job! Your housing costs are only ${housingPercent.toFixed(0)}% of income, well below the 30-35% guideline.`);
                }
            }
            
            // Transportation insights (should be 10-15% of income)
            const transportCategory = analytics.categoryData.find(c => c.name === 'Transportation');
            if (transportCategory) {
                const transportPercent = (transportCategory.value / (analytics.totalIncome / analytics.monthlyTrends.length) * analytics.monthlyTrends.length * 100);
                if (transportPercent > 15) {
                    insights.push(`Your transportation costs are ${transportPercent.toFixed(0)}% of income. Consider ways to reduce this below 15%.`);
                }
            }

            const monthlyIncrease = analytics.monthlyTrends.length > 1 ? 
                ((analytics.monthlyTrends[analytics.monthlyTrends.length - 1].expenses - analytics.monthlyTrends[analytics.monthlyTrends.length - 2].expenses) / analytics.monthlyTrends[analytics.monthlyTrends.length - 2].expenses * 100) : 0;
            
            if (monthlyIncrease > 10) {
                insights.push(`‚ö†Ô∏è Your expenses increased by ${monthlyIncrease.toFixed(1)}% last month. Review your recent spending.`);
            } else if (monthlyIncrease < -10) {
                insights.push(`‚úÖ Excellent! Your expenses decreased by ${Math.abs(monthlyIncrease).toFixed(1)}% last month.`);
            }

            if (analytics.currentBalance < analytics.avgMonthlyExpenses * 3) {
                insights.push(`Build your emergency fund to at least ${(analytics.avgMonthlyExpenses * 3).toFixed(0)} (3 months of expenses).`);
            } else if (analytics.currentBalance >= analytics.avgMonthlyExpenses * 6) {
                insights.push(`‚úÖ Excellent! You have ${(analytics.currentBalance / analytics.avgMonthlyExpenses).toFixed(1)} months of expenses saved.`);
            }

            const miscCategory = analytics.categoryData.find(c => c.name === 'Miscellaneous');
            if (miscCategory && miscCategory.value > analytics.totalExpenses * 0.15) {
                insights.push(`${(miscCategory.value / analytics.totalExpenses * 100).toFixed(1)}% of your spending is "Miscellaneous". Use the Transactions tab to recategorize these for better insights.`);
            }
            
            // Dining out vs groceries comparison
            const diningCategory = analytics.categoryData.find(c => c.name === 'Dining Out');
            const groceryCategory = analytics.categoryData.find(c => c.name === 'Groceries');
            if (diningCategory && groceryCategory && diningCategory.value > groceryCategory.value * 0.5) {
                insights.push(`You're spending ${diningCategory.value.toLocaleString()} on dining out vs ${groceryCategory.value.toLocaleString()} on groceries. Cooking more at home could save significantly.`);
            }

            document.getElementById('insightsList').innerHTML = insights.map(i => `<li>${i}</li>`).join('');
        }

        function generateActionPlan(analytics) {
            const shortTerm = [];
            const mediumTerm = [];
            const longTerm = [];

            const savingsRate = ((analytics.totalIncome - analytics.totalExpenses) / analytics.totalIncome * 100);
            
            // Review top spending category
            const topSpending = analytics.categoryData[0];
            if (topSpending.name === 'Housing' && topSpending.value / (analytics.totalIncome / analytics.monthlyTrends.length) > 0.35) {
                shortTerm.push({
                    text: 'Your housing costs exceed 35% of income. Explore options to reduce: roommate, refinance, or downsize',
                    impact: 'Reduce to 30%'
                });
            }
            
            if (topSpending.name === 'Dining Out') {
                const avgPerMonth = topSpending.value / analytics.monthlyTrends.length;
                shortTerm.push({
                    text: 'Reduce dining out frequency by half and meal prep at home more often',
                    impact: `Save ${Math.round(avgPerMonth * 0.5)}/mo`
                });
            }

            // Utilities optimization
            const utilitiesCategory = analytics.categoryData.find(c => c.name === 'Utilities');
            if (utilitiesCategory) {
                const avgMonthly = utilitiesCategory.value / analytics.monthlyTrends.length;
                if (avgMonthly > 300) {
                    shortTerm.push({
                        text: 'Call internet, phone, and cable providers to negotiate better rates or switch plans',
                        impact: 'Save $50-100/mo'
                    });
                }
            }

            // Insurance review
            const insuranceCategory = analytics.categoryData.find(c => c.name === 'Insurance');
            if (insuranceCategory) {
                shortTerm.push({
                    text: 'Shop around for insurance quotes (auto, home, life) - many people overpay by staying with same provider',
                    impact: 'Save $30-80/mo'
                });
            }

            // Savings rate improvement
            if (savingsRate < 15) {
                const targetSavings = (analytics.avgMonthlyIncome * 0.15);
                const currentSavings = analytics.avgMonthlyIncome - analytics.avgMonthlyExpenses;
                const gap = targetSavings - currentSavings;
                
                shortTerm.push({
                    text: `Set up automatic transfer of ${Math.round(gap)}/mo to savings account on payday`,
                    impact: 'Reach 15% savings rate'
                });
            }

            // Debt payoff
            const debtCategory = analytics.categoryData.find(c => c.name === 'Debt Payments');
            if (debtCategory) {
                mediumTerm.push({
                    text: 'List all debts by interest rate and create a debt payoff plan (avalanche method)',
                    impact: 'Save on interest'
                });
            }

            // Emergency fund
            if (analytics.currentBalance < analytics.avgMonthlyExpenses * 3) {
                mediumTerm.push({
                    text: `Build emergency fund to ${(analytics.avgMonthlyExpenses * 6).toFixed(0)} (6 months of expenses)`,
                    impact: 'Financial security'
                });
            }

            // Healthcare costs
            const healthcareCategory = analytics.categoryData.find(c => c.name === 'Healthcare');
            if (healthcareCategory && healthcareCategory.value / analytics.monthlyTrends.length > 200) {
                mediumTerm.push({
                    text: 'Review health insurance plan options during open enrollment for better coverage or lower costs',
                    impact: 'Save $50-200/mo'
                });
            }

            // Subscription audit
            const entertainmentCategory = analytics.categoryData.find(c => c.name === 'Entertainment');
            if (entertainmentCategory) {
                mediumTerm.push({
                    text: 'Audit all streaming services and subscriptions - cancel unused ones, share accounts with family',
                    impact: 'Save $30-80/mo'
                });
            }

            // Transportation review
            const transportCategory = analytics.categoryData.find(c => c.name === 'Transportation');
            if (transportCategory && transportCategory.value / (analytics.totalIncome / analytics.monthlyTrends.length) > 0.15) {
                mediumTerm.push({
                    text: 'Evaluate transportation costs: refinance auto loan, use public transit, or carpool when possible',
                    impact: 'Reduce to 10-15%'
                });
            }

            // Long-term goals
            longTerm.push({
                text: 'Increase income through skill development, certifications, or asking for 10-15% raise at performance review',
                impact: `+${(analytics.avgMonthlyIncome * 0.125).toFixed(0)}/mo`
            });

            longTerm.push({
                text: 'Start investing in low-cost index funds (after emergency fund is built) with 10-15% of income',
                impact: 'Long-term wealth building'
            });

            longTerm.push({
                text: 'Max out employer 401(k) match if available (free money!), then contribute to Roth IRA',
                impact: 'Retirement security'
            });

            longTerm.push({
                text: 'Set specific financial goals with timelines: down payment fund, vacation savings, etc.',
                impact: 'Clear direction'
            });

            // Ensure we have at least 3 items in each section
            if (shortTerm.length < 3) {
                shortTerm.push({
                    text: 'Track every expense for 30 days to identify spending leaks and behavioral patterns',
                    impact: 'Awareness'
                });
            }
            
            if (shortTerm.length < 3) {
                shortTerm.push({
                    text: 'Set up bill payment reminders to avoid late fees and maintain good credit score',
                    impact: 'Save $25-50/mo'
                });
            }

            if (mediumTerm.length < 3) {
                mediumTerm.push({
                    text: 'Create a sinking fund for irregular expenses (car maintenance, gifts, annual fees)',
                    impact: 'Avoid surprises'
                });
            }

            document.getElementById('shortTermPlan').innerHTML = shortTerm.map(item => `
                <div class="plan-item">
                    <input type="checkbox" class="plan-checkbox" />
                    <div class="plan-text">${item.text}</div>
                    <div class="plan-impact">${item.impact}</div>
                </div>
            `).join('');

            document.getElementById('mediumTermPlan').innerHTML = mediumTerm.map(item => `
                <div class="plan-item">
                    <input type="checkbox" class="plan-checkbox" />
                    <div class="plan-text">${item.text}</div>
                    <div class="plan-impact">${item.impact}</div>
                </div>
            `).join('');

            document.getElementById('longTermPlan').innerHTML = longTerm.map(item => `
                <div class="plan-item">
                    <input type="checkbox" class="plan-checkbox" />
                    <div class="plan-text">${item.text}</div>
                    <div class="plan-impact">${item.impact}</div>
                </div>
            `).join('');
        }

        function createBudgetSection(analytics) {
            const budgetHtml = analytics.categoryData.map(cat => {
                const currentSpending = cat.value / analytics.monthlyTrends.length;
                const targetBudget = budgetTargets[cat.name] || Math.round(currentSpending);
                const percentage = (currentSpending / targetBudget) * 100;
                
                let statusClass = 'good';
                if (percentage > 100) statusClass = 'danger';
                else if (percentage > 85) statusClass = 'warning';

                return `
                    <div class="budget-item">
                        <div class="budget-header">
                            <strong style="color: #2d3748;">${cat.name}</strong>
                            <div>
                                <span style="color: #718096; margin-right: 10px;">Target:</span>
                                <input type="number" class="budget-input" value="${targetBudget}" 
                                       data-category="${cat.name}" onchange="updateBudgetTarget('${cat.name}', this.value)" />
                            </div>
                        </div>
                        <div class="budget-bar">
                            <div class="budget-fill ${statusClass}" style="width: ${Math.min(percentage, 100)}%;">
                                $${currentSpending.toFixed(0)} / $${targetBudget}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('budgetItems').innerHTML = budgetHtml;

            if (charts.budgetChart) charts.budgetChart.destroy();
            charts.budgetChart = new Chart(document.getElementById('budgetChart'), {
                type: 'bar',
                data: {
                    labels: analytics.categoryData.map(c => c.name),
                    datasets: [
                        {
                            label: 'Target Budget',
                            data: analytics.categoryData.map(c => budgetTargets[c.name] || (c.value / analytics.monthlyTrends.length)),
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Actual Spending',
                            data: analytics.categoryData.map(c => c.value / analytics.monthlyTrends.length),
                            backgroundColor: '#3b82f6'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        function updateBudgetTarget(category, value) {
            budgetTargets[category] = parseFloat(value);
        }

        function saveBudget() {
            alert('Budget targets saved! These will be used for future analysis.');
            processData();
        }

        function populateFilters() {
            const types = [...new Set(allTransactions.map(t => t.Type))];
            const typeFilter = document.getElementById('typeFilter');
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });

            const categoryFilter = document.getElementById('categoryFilter');
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
        }

        function populateTransactions() {
            displayedTransactionCount = 100;
            filterTransactions();
            setupInfiniteScroll();
        }

        function setupInfiniteScroll() {
            const scrollContainer = document.getElementById('tableScrollContainer');
            
            scrollContainer.onscroll = function() {
                if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 50) {
                    loadMoreTransactions();
                }
            };
        }

        function loadMoreTransactions() {
            if (displayedTransactionCount >= filteredTransactionsList.length || isLoadingMore) return;
            
            isLoadingMore = true;
            document.getElementById('loadingMore').style.display = 'block';
            
            setTimeout(() => {
                displayedTransactionCount += 100;
                renderTransactions();
                document.getElementById('loadingMore').style.display = 'none';
                isLoadingMore = false;
            }, 300);
        }

        function filterTransactions() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const days = parseInt(document.getElementById('dateFilter').value);

            let filtered = [...allTransactions].reverse();

            if (search) {
                filtered = filtered.filter(t => t.Description.toLowerCase().includes(search));
            }

            if (type !== 'all') {
                filtered = filtered.filter(t => t.Type === type);
            }

            if (category !== 'all') {
                filtered = filtered.filter(t => t.Category === category);
            }

            if (days !== 'all' && !isNaN(days)) {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                filtered = filtered.filter(t => new Date(t.Date) >= cutoff);
            }

            filteredTransactionsList = filtered;
            displayedTransactionCount = 100;
            
            const scrollContainer = document.getElementById('tableScrollContainer');
            if (scrollContainer) scrollContainer.scrollTop = 0;
            
            renderTransactions();
        }

        function renderTransactions() {
            const toDisplay = filteredTransactionsList.slice(0, displayedTransactionCount);
            
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = toDisplay.map(t => `
                <tr class="transaction-row ${selectedTransactions.has(t._id) ? 'selected' : ''}" data-id="${t._id}">
                    <td>
                        <input type="checkbox" class="select-checkbox" 
                               ${selectedTransactions.has(t._id) ? 'checked' : ''}
                               onchange="toggleTransactionSelect(${t._id})" />
                    </td>
                    <td>${new Date(t.Date).toLocaleDateString()}</td>
                    <td>${t.Description}</td>
                    <td>${t.Type}</td>
                    <td>
                        <span class="category-tag category-${t.Category.replace(/[^a-zA-Z]/g, '')}" 
                              onclick="openCategoryModal(${t._id})">
                            ${t.Category}
                        </span>
                    </td>
                    <td style="text-align: right;" class="${t.Amount > 0 ? 'positive' : 'negative'}">
                        ${t.Amount > 0 ? '+' : ''}${Math.abs(t.Amount).toFixed(2)}
                    </td>
                    <td style="text-align: right;">${t['Current balance'].toFixed(2)}</td>
                </tr>
            `).join('');

            const countText = filteredTransactionsList.length > displayedTransactionCount 
                ? `Showing ${displayedTransactionCount} of ${filteredTransactionsList.length} transactions (scroll for more)`
                : `${filteredTransactionsList.length} transactions`;
            
            document.getElementById('transactionCount').textContent = countText;
        }

        function toggleTransactionSelect(transactionId) {
            if (selectedTransactions.has(transactionId)) {
                selectedTransactions.delete(transactionId);
            } else {
                selectedTransactions.add(transactionId);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const visibleTransactions = filteredTransactionsList.slice(0, displayedTransactionCount);
            
            if (selectAll) {
                visibleTransactions.forEach(t => selectedTransactions.add(t._id));
            } else {
                visibleTransactions.forEach(t => selectedTransactions.delete(t._id));
            }
            
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedTransactions.size > 0) {
                bulkActions.classList.add('active');
                selectedCount.textContent = `${selectedTransactions.size} selected`;
            } else {
                bulkActions.classList.remove('active');
            }
            
            renderTransactions();
        }

        function clearSelection() {
            selectedTransactions.clear();
            document.getElementById('selectAll').checked = false;
            updateSelectionUI();
        }

        function bulkRecategorize() {
            if (selectedTransactions.size === 0) return;
            
            document.getElementById('modalDescription').textContent = `Recategorize ${selectedTransactions.size} selected transactions`;
            
            const optionsHtml = categories.map(cat => `
                <div class="category-option" onclick="selectCategory('${cat}')">
                    ${cat}
                </div>
            `).join('');
            
            document.getElementById('categoryOptions').innerHTML = optionsHtml;
            document.getElementById('categoryModal').classList.add('active');
            currentEditTransaction = { isBulk: true };
        }

        function openCategoryModal(transactionId) {
            currentEditTransaction = allTransactions.find(t => t._id === transactionId);
            if (!currentEditTransaction) return;

            document.getElementById('modalDescription').textContent = `${currentEditTransaction.Description} (Current: ${currentEditTransaction.Category})`;
            
            const optionsHtml = categories.map(cat => `
                <div class="category-option" onclick="selectCategory('${cat}')">
                    ${cat}
                </div>
            `).join('');
            
            document.getElementById('categoryOptions').innerHTML = optionsHtml;
            document.getElementById('categoryModal').classList.add('active');
        }

        function selectCategory(category) {
            document.querySelectorAll('.category-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            if (currentEditTransaction) {
                currentEditTransaction.tempCategory = category;
            }
        }

        function saveCategory() {
            if (!currentEditTransaction || !currentEditTransaction.tempCategory) {
                alert('Please select a category first!');
                return;
            }

            if (currentEditTransaction.isBulk) {
                selectedTransactions.forEach(id => {
                    const transaction = allTransactions.find(t => t._id === id);
                    if (transaction) {
                        transaction.CustomCategory = currentEditTransaction.tempCategory;
                        transaction.Category = currentEditTransaction.tempCategory;
                    }
                });
                clearSelection();
            } else {
                currentEditTransaction.CustomCategory = currentEditTransaction.tempCategory;
                currentEditTransaction.Category = currentEditTransaction.tempCategory;
            }
            
            closeModal();
            processData();
        }

        function closeModal() {
            document.getElementById('categoryModal').classList.remove('active');
            currentEditTransaction = null;
        }

        function exportCSV() {
            const headers = ['Date', 'Description', 'Type', 'Amount', 'Current balance', 'Status', 'CustomCategory'];
            const csvContent = [
                headers.join(','),
                ...allTransactions.map(t => [
                    t.Date,
                    `"${t.Description}"`,
                    t.Type,
                    t.Amount,
                    t['Current balance'],
                    t.Status,
                    t.CustomCategory || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_data_tagged.csv';
            a.click();
            window.URL.revokeObjectURL(url);

            alert('‚úÖ CSV exported with your custom categories! Upload this file to see your categorization improvements.');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            const activeTab = Array.from(document.querySelectorAll('.tab')).find(t => 
                t.getAttribute('onclick').includes(tabName)
            );
            if (activeTab) activeTab.classList.add('active');
            
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }
    </script>
</body>
</html>
